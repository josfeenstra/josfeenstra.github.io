(()=>{"use strict";class t{static clamp(t,e,i){return Math.min(Math.max(t,e),i)}static smooth(t){return t*t*t*(t*(6*t-15)+10)}static fraction(t,e,i){return(t-e)/(i-e)}static lerp(t,e,i){return t+i*(e-t)}static radToDeg(t){return 180*t/Math.PI}static degToRad(t){return t*Math.PI/180}static factorial(t){let e=1;for(let i=1;i<t+1;i++)e*=i;return e}static stack(t){let e=0;for(let i=1;i<t+1;i++)e+=i;return e}static sample(t,e){let i=e*(t.length-1),s=Math.floor(i),r=Math.ceil(i);return this.lerp(t[s],t[r],i-s)}static sampleSmooth(t,e){let i=e*(t.length-1),s=Math.floor(i),r=Math.ceil(i);return this.lerp(t[s],t[r],this.smooth(i-s))}static between(t,e){let i=0,s=t.length-1;for(let r=0;r<t.length;r++){if(i>s){console.log("start",i,"end",s);let t=s;s=i,i=t;break}let r=Math.round((s-i)/2);if(e<t[r])i=r;else{if(!(e>t[r])){i=r,s=r;break}s=r}}return[i,s]}}class e{constructor(t,e){this.verts=t,this.links=e}clone(){return new e(this.verts.clone(),this.links.clone())}static new(t,i){return new e(t,i)}static fromLists(t,i){return new e(l.fromList(t),_.fromList(i,3))}static newEmpty(t,i,s){return new e(l.new(t),new _(i,s))}static newLines(t,i){let s=l.fromList(t),r=_.fromList(i,2);return new e(s,r)}static fromBiSurface(t,i=10,s=10){let r=i+1,n=s+1,o=l.new(r*n),a=new _(i*s*2,3);for(let e=0;e<r;e++)for(let r=0;r<n;r++){let a=e*n+r;o.set(a,t.pointAt(e/i,r/s))}for(let t=0;t<i;t++)for(let e=0;e<s;e++){let i=2*(t*s+e),o=t*r+e,h=o+n,l=o+1,u=h+1;a.setRow(i,[o,h,u]),a.setRow(i+1,[l,o,u])}return new e(o,a)}static fromTriSurface(i,s=10){let r=s+1,n=l.new(t.stack(r)),o=new _(t.stack(r),3);return new e(n,o)}static zero(){return new e(l.new(0),new _(0,0))}static fromJoin(t){let i=0,s=0;for(let e of t)i+=e.verts.count,s+=e.links.count();let r=l.new(i),n=new _(s,3),o=0,a=0;for(let e of t){for(let t=0;t<e.verts.count;t++)r.set(o+t,e.verts.get(t));for(let t=0;t<e.links.count();t++){let i=e.links.getRow(t);for(let t=0;t<i.length;t++)i[t]=i[t]+o;n.setRow(a+t,i)}o+=e.verts.count,a+=e.links.count()}return new e(r,n)}static fromRect(t){let e=t.getCorners(),r=[];r.push(...s(i[0]));let n=new D(4,0,0,2);return n.mesh.verts.fillFromList(e),n.mesh.links.setData(r),n.setUvs(new Float32Array([0,0,0,1,1,0,1,1])),n}static fromRectangle(t){let e=t.getCorners(),r=[];return r.push(...s(i[0])),this.fromLists(e,r)}static newQuad(t){let e=[...s(i[0])];return this.fromLists(t,e)}static newOct(t){let e=[];for(let t of i)e.push(...s(t));return this.fromLists(t,e)}static fromCube(t){let i=t.getCorners();return e.newOct(i)}static newIcosahedron(t=1){let e=new N,i=t,s=i*((1+Math.pow(5,.5))/2),r=t=>{e.addVert(t,t)};r(new c(-i,-s,0)),r(new c(i,-s,0)),r(new c(-i,s,0)),r(new c(i,s,0)),r(new c(0,-i,-s)),r(new c(0,i,-s)),r(new c(0,-i,s)),r(new c(0,i,s)),r(new c(-s,0,-i)),r(new c(-s,0,i)),r(new c(s,0,-i)),r(new c(s,0,i));let n=(t,i)=>{e.addEdge(t,i)};for(let t=0;t<12;t+=4){n(t+0,t+1),n(t+2,t+3);let e=(t+4)%12;n(t+0,e+2),n(t+0,e+0),n(t+1,e+2),n(t+1,e+0),n(t+2,e+3),n(t+2,e+1),n(t+3,e+3),n(t+3,e+1)}return this.fromGraph(e)}static newSphere(t,i,s,r){let n=s*r+2,o=l.new(n),a=function(e,s){o.set(e,s.scale(i).add(t))};a(0,new c(0,0,1));for(let t=0;t<s;t++)for(let e=0;e<r;e++){let i=Math.PI*(t+1)/(s+1),n=2*Math.PI*e/r,o=Math.sin(i)*Math.cos(n),h=Math.sin(i)*Math.sin(n),l=Math.cos(i);a(1+t*r+e,new c(o,h,l))}a(n-1,new c(0,0,-1));let h=r*s*2,u=new _(h,3);u.fill(-1);let d=function(t,e){u.setRow(t,e)};for(let t=0;t<r;t++)d(t,[0,t+1,(t+1)%r+1]);for(let t=0;t<s-1;t++){let e=r*t+1,i=e+r;for(let s=0;s<r;s++){let n=e+(s+1)%r,o=i+s,a=i+(s+1)%r,h=r+r*t*2+2*s;d(h,[e+s,o,n]),d(h+1,[o,a,n])}}for(let t=0;t<r;t++){let e=n-r-1;d(h-r+t,[n-1,e+(t+1)%r,e+t])}return new e(o,u)}static newCylinder(t,i,s,r){let n=i.subbed(t),o=2*r+2,a=2*(o-2),h=l.new(o),u=function(t,e){h.set(t,e)},d=T.fromPN(t,n),f=T.fromPN(i,n);u(0,t);for(let t=0;t<r;t++){let e=new c(Math.cos(2*Math.PI*t/r),Math.sin(2*Math.PI*t/r),0).scale(s);e=d.matrix.multiplyVector(e),u(t+1,e)}let m=o/2;for(let t=0;t<r;t++){let e=new c(Math.cos(2*Math.PI*t/r),Math.sin(2*Math.PI*t/r),0).scale(s);e=f.matrix.multiplyVector(e),u(m+t,e)}u(o-1,i);let g=new _(a,3);g.fill(-1);let w=function(t,e){g.setRow(t,e)};for(let t=0;t<r;t++){let e=1+t,i=1+(t+1)%r,s=o-1,n=m+t,a=m+(t+1)%r;w(4*t,[0,i,e]),w(4*t+1,[e,i,n]),w(4*t+2,[i,a,n]),w(4*t+3,[s,n,a])}return new e(h,g)}static newCone(t,i,s,r){let n=r+2,o=2*r,a=l.new(n),h=function(e,i){a.set(e,i.add(t))},u=new _(o,3);u.fill(-1);let d=function(t,e){u.setRow(t,e)};h(0,new c(0,0,0));for(let t=0;t<r;t++)h(t+1,new c(Math.cos(2*Math.PI*t/r),Math.sin(2*Math.PI*t/r),0).scale(i));h(n-1,new c(0,0,s));for(let t=0;t<r;t++){let e=n-1,i=1+t,s=1+(t+1)%r;d(2*t,[0,s,i]),d(2*t+1,[i,s,e])}return new e(a,u)}static fromGraph(t){let i=l.fromList(t.allVertPositions()),s=t.allVertLoopsAsInts(),r=new _(s.length,3);return s.forEach(((t,e)=>{3==t.length?r.setRow(e,t):console.log("cant convert loop")})),e.new(i,r)}toLines(){const t=t=>{let e=this.links.count()*t,i=new _(e,2);for(let e=0;e<this.links.count();e++)for(let s=0;s<t;s++){let r=(s+1)%t,n=e*t+s;i.set(n,0,this.links.get(e,s)),i.set(n,1,this.links.get(e,r))}return i};let i=this.getType();if(i==P.Lines)return this.clone();if(i==P.Triangles){let i=t(3);return e.new(this.verts.clone(),i)}if(i==P.Quads){let i=t(4);return e.new(this.verts.clone(),i)}return console.warn("cannot convert to lines"),e.newEmpty(0,0,0)}toRenderable(){return D.fromMesh(this)}toGraph(){return N.fromMesh(this)}getType(){return this.links._width==P.Points?P.Points:this.links._width==P.Lines?P.Lines:this.links._width==P.Triangles?P.Triangles:this.links._width==P.Quads?P.Quads:P.Invalid}getLinkVerts(t){let e=l.new(this.links._width);return this.links.getRow(t).forEach(((t,i)=>{e.set(i,this.verts.get(t))})),e}calculateFaceNormals(){let t=[];if(this.getType()!=P.Triangles)return console.error("can only calculate normals from triangular meshes"),t;let e=this.links.count();for(let i=0;i<e;i++){let e=this.getLinkVerts(i).toList(),s=e[1].subbed(e[0]).cross(e[2].subbed(e[0])).normalize();t.push(s)}return t}calculateVertexNormals(){let t=this.links.count(),e=this.calculateFaceNormals(),i=l.new(this.verts.count);for(let s=0;s<t;s++){let t=e[s];this.links.getRow(s).forEach((e=>{let s=i.get(e);i.set(e,s.add(t))}))}let s=i.toList();for(let t=0;t<s.length;t++)s[t].normalize();return s}}const i=[[0,1,3,2],[4,0,2,6],[1,0,4,5],[1,5,7,3],[2,3,7,6],[5,4,6,7]];function s(t){return[t[0],t[2],t[1],t[0],t[3],t[2]]}class r{static IsRouglyZero(t){return Math.abs(t)<this.TOLERANCE}}r.TOLERANCE=1e-4,r.TOL_SQUARED=Math.pow(r.TOLERANCE,2),r.MAX_U16=65536,r.PLANE_RENDER_LINECOUNT=9,r.PLANE_RENDER_LINEDISTANCE=.3,r.CIRCLE_SEGMENTS=100,r.BEZIER_SEGMENTS=100;class n{constructor(t,e,i=[]){this.height=t,this.width=e,this.data=new Float32Array(this.width*this.height),i==[]||0==i.length||this.setData(i)}print(){let t=[];for(var e=0;e<this.width;e++){t.push("|");for(var i=0;i<this.height;i++){let s=this.get(i,e).toFixed(2);s=s.padStart(8," "),t.push(s),i<this.width-2&&t.push("  ")}t.push("  |\n")}console.log(t.join(""))}setData(t){if(t.length!=this.height*this.width)throw"data.length does not match width * height "+t.length.toString();this.data.set(t)}count(){return this.height}getDimensions(){return[this.height,this.width]}fill(t){let e=this.height*this.width;for(let i=0;i<e;i++)this.data[i]=t}fillWith(t,e=this.width){let i=e;if(i>this.width)throw"values per entry is larger than this._width. This will spill over.";for(let e=0;e<this.height;e++)for(let s=0;s<i;s++)this.set(e,s,t[e*i+s])}fillFrom(t){if(t.height<this.height||t.width<this.width)throw new Error("need same dimentions");for(let e=0;e<t.height;e++)for(let i=0;i<2;i++)this.set(e,i,t.get(e,i));return this}get(t,e){return this.data[t*this.width+e]}getRow(t){let e=new Float32Array(this.width);for(let i=0;i<this.width;i++)e[i]=this.get(t,i);return e}getColumn(t){let e=new Float32Array(this.height);for(let i=0;i<this.height;i++){let s=i*this.width+t;e[i]=this.data[s]}return e}set(t,e,i){this.data[t*this.width+e]=i}setRow(t,e){for(let i=0;i<this.width;i++)this.set(t,i,e[i])}forEachValue(t){for(let e=0;e<this.data.length;e++)this.data[e]=t(this.data[e],e);return this}takeRows(t){const e=t.length;let i=new n(e,this.width);for(let s=0;s<e;s++){let e=t[s];i.setRow(s,this.getRow(e))}return i}mapWith(t,e){let i=this.clone(),s=Math.min(this.width,t.height),r=Math.min(this.height,t.height);for(var n=0;n<r;n++)for(var o=0;o<s;o++)i.set(n,o,e(this.get(n,o),t.get(n,o)));return i}multiplied(t){let e=this;if(t.height!==e.width)throw new Error(`Columns in A should be the same as the number of rows in B\n                b.width ${t.height},\n                a.height ${e.width}`);for(var i=new n(e.height,t.width),s=0;s<i.height;s++)for(var r=0;r<t.width;r++)for(var o=0;o<e.width;o++)i.set(s,r,i.get(s,r)+e.get(s,o)*t.get(o,r));return i}multiply(t){let e=this.multiplied(t);return this.data=e.data,this}static fromNative(t){let e=t.length,i=t[0].length,s=new n(e,i);for(var r=0;r<t.length;r++)for(var o=0;o<t[0].length;o++)s.set(r,o,t[r][o]);return s}toNative(){let t=[];for(var e=0;e<this.height;e++){t[e]=[];for(var i=0;i<this.width;i++)t[e][i]=this.get(e,i)}return t}clone(){let t=new n(this.height,this.width);for(let e=0;e<this.data.length;e++)t.data[e]=this.data[e];return t}}class o extends n{constructor(t=[]){super(4,4,t)}static new(t){return new o(t)}static newIdentity(){return new o([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}static newCopy(t){let e=new o;for(let i=0;i<16;i++)e.data[i]=t.data[i];return e}clone(){return o.newCopy(this)}multiplied(t){const e=t.data,i=this.data;var s=i[0],r=i[1],n=i[2],a=i[3],h=i[4],l=i[5],u=i[6],c=i[7],d=i[8],f=i[9],m=i[10],g=i[11],w=i[12],p=i[13],x=i[14],v=i[15],_=e[0],y=e[1],b=e[2],E=e[3],R=e[4],A=e[5],M=e[6],T=e[7],P=e[8],L=e[9],D=e[10],F=e[11],S=e[12],z=e[13],N=e[14],k=e[15];return new o([s*_+r*R+n*P+a*S,s*y+r*A+n*L+a*z,s*b+r*M+n*D+a*N,s*E+r*T+n*F+a*k,h*_+l*R+u*P+c*S,h*y+l*A+u*L+c*z,h*b+l*M+u*D+c*N,h*E+l*T+u*F+c*k,d*_+f*R+m*P+g*S,d*y+f*A+m*L+g*z,d*b+f*M+m*D+g*N,d*E+f*T+m*F+g*k,w*_+p*R+x*P+v*S,w*y+p*A+x*L+v*z,w*b+p*M+x*D+v*N,w*E+p*T+x*F+v*k])}multiply(t){return this.data=this.multiplied(t).data,this}transpose(){let t=new o,e=t.data,i=this.data;return e[0]=i[0],e[1]=i[4],e[2]=i[8],e[3]=i[12],e[4]=i[1],e[5]=i[5],e[6]=i[9],e[7]=i[13],e[8]=i[2],e[9]=i[6],e[10]=i[10],e[11]=i[14],e[12]=i[3],e[13]=i[7],e[14]=i[11],e[15]=i[15],t}static newLookAt(t,e,i){let s=new o,r=s.data,n=t.clone().sub(e).normalize(),a=i.clone().cross(i).normalize(),h=n.clone().cross(a).normalize();return r[0]=a.x,r[1]=a.y,r[2]=a.z,r[3]=0,r[4]=h.x,r[5]=h.y,r[6]=h.z,r[7]=0,r[8]=n.x,r[9]=n.y,r[10]=n.z,r[11]=0,r[12]=t.x,r[13]=t.y,r[14]=t.z,r[15]=1,s}static newPerspective(t,e,i,s){let r=new o,n=r.data;var a=Math.tan(.5*Math.PI-.5*t),h=1/(i-s);return n[0]=a/e,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=(i+s)*h,n[11]=-1,n[12]=0,n[13]=0,n[14]=i*s*h*2,n[15]=0,r}static newOrthographic(t,e,i,s,r,n){let a=new o,h=a.data;return h[0]=2/(e-t),h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2/(s-i),h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=2/(r-n),h[11]=0,h[12]=(t+e)/(t-e),h[13]=(i+s)/(i-s),h[14]=(r+n)/(r-n),h[15]=1,a}static newFrustum(t,e,i,s,r,n){let a=new o,h=a.data;var l=e-t,u=s-i,c=n-r;return h[0]=2*r/l,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2*r/u,h[6]=0,h[7]=0,h[8]=(t+e)/l,h[9]=(s+i)/u,h[10]=-(n+r)/c,h[11]=-1,h[12]=0,h[13]=0,h[14]=-2*r*n/c,h[15]=0,a}static newTranslation(t,e,i){return new o([1,0,0,0,0,1,0,0,0,0,1,0,t,e,i,1])}static newTranslate(t){return new o([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,t.z,1])}static newXRotation(t){var e=Math.cos(t),i=Math.sin(t);return new o([1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1])}static newYRotation(t){var e=Math.cos(t),i=Math.sin(t);return new o([e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1])}static newZRotation(t){let e=new o,i=e.data;var s=Math.cos(t),r=Math.sin(t);return i[0]=s,i[1]=r,i[2]=0,i[3]=0,i[4]=-r,i[5]=s,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,e}static newAxisRotation(t,e){let i=new o,s=i.data,r=t.x,n=t.y,a=t.z,h=Math.sqrt(r*r+n*n+a*a);r/=h,n/=h,a/=h;let l=r*r,u=n*n,c=a*a,d=Math.cos(e),f=Math.sin(e),m=1-d;return s[0]=l+(1-l)*d,s[1]=r*n*m+a*f,s[2]=r*a*m-n*f,s[3]=0,s[4]=r*n*m-a*f,s[5]=u+(1-u)*d,s[6]=n*a*m+r*f,s[7]=0,s[8]=r*a*m+n*f,s[9]=n*a*m-r*f,s[10]=c+(1-c)*d,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,i}axisRotate(t,e){let i=new o,s=i.data,r=this.data;var n=t.x,a=t.y,h=t.z,l=Math.sqrt(n*n+a*a+h*h),u=(n/=l)*n,c=(a/=l)*a,d=(h/=l)*h,f=Math.cos(e),m=Math.sin(e),g=1-f,w=u+(1-u)*f,p=n*a*g+h*m,x=n*h*g-a*m,v=n*a*g-h*m,_=c+(1-c)*f,y=a*h*g+n*m,b=n*h*g+a*m,E=a*h*g-n*m,R=d+(1-d)*f,A=r[0],M=r[1],T=r[2],P=r[3],L=r[4],D=r[5],F=r[6],S=r[7],z=r[8],N=r[9],k=r[10],B=r[11];return s[0]=w*A+p*L+x*z,s[1]=w*M+p*D+x*N,s[2]=w*T+p*F+x*k,s[3]=w*P+p*S+x*B,s[4]=v*A+_*L+y*z,s[5]=v*M+_*D+y*N,s[6]=v*T+_*F+y*k,s[7]=v*P+_*S+y*B,s[8]=b*A+E*L+R*z,s[9]=b*M+E*D+R*N,s[10]=b*T+E*F+R*k,s[11]=b*P+E*S+R*B,r!==s&&(s[12]=r[12],s[13]=r[13],s[14]=r[14],s[15]=r[15]),i}static newScaler(t,e,i){return new o([t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1])}scale(t,e,i){let s=new o,r=s.data,n=this.data;return r[0]=t*n[0],r[1]=t*n[1],r[2]=t*n[2],r[3]=t*n[3],r[4]=e*n[4],r[5]=e*n[5],r[6]=e*n[6],r[7]=e*n[7],r[8]=i*n[8],r[9]=i*n[9],r[10]=i*n[10],r[11]=i*n[11],n!==r&&(r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15]),s}newCompose(t,e,i){let s=new o,r=s.data;const n=e.x,a=e.y,h=e.z,l=e.w,u=n+n,c=a+a,d=h+h,f=n*u,m=n*c,g=n*d,w=a*c,p=a*d,x=h*d,v=l*u,_=l*c,y=l*d,b=i.x,E=i.y,R=i.z;return r[0]=(1-(w+x))*b,r[1]=(m+y)*b,r[2]=(g-_)*b,r[3]=0,r[4]=(m-y)*E,r[5]=(1-(f+x))*E,r[6]=(p+v)*E,r[7]=0,r[8]=(g+_)*R,r[9]=(p-v)*R,r[10]=(1-(f+w))*R,r[11]=0,r[12]=t.x,r[13]=t.y,r[14]=t.z,r[15]=1,s}determinate(){let t=this.data;var e=t[0],i=t[1],s=t[2],r=t[3],n=t[4],o=t[5],a=t[6],h=t[7],l=t[8],u=t[9],c=t[10],d=t[11],f=t[12],m=t[13],g=t[14],w=t[15],p=c*w,x=g*d,v=a*w,_=g*h,y=a*d,b=c*h,E=s*w,R=g*r,A=s*d,M=c*r,T=s*h,P=a*r;return 1/(e*(p*o+_*u+y*m-(x*o+v*u+b*m))+n*(x*i+E*u+M*m-(p*i+R*u+A*m))+l*(v*i+R*o+T*m-(_*i+E*o+P*m))+f*(b*i+A*o+P*u-(y*i+M*o+T*u)))}inverse(){let t=new o,e=t.data,i=this.data;var s=i[0],r=i[1],n=i[2],a=i[3],h=i[4],l=i[5],u=i[6],c=i[7],d=i[8],f=i[9],m=i[10],g=i[11],w=i[12],p=i[13],x=i[14],v=i[15],_=m*v,y=x*g,b=u*v,E=x*c,R=u*g,A=m*c,M=n*v,T=x*a,P=n*g,L=m*a,D=n*c,F=u*a,S=d*p,z=w*f,N=h*p,k=w*l,B=h*f,C=d*l,I=s*p,U=w*r,V=s*f,Y=d*r,O=s*l,j=h*r,W=_*l+E*f+R*p-(y*l+b*f+A*p),X=y*r+M*f+L*p-(_*r+T*f+P*p),q=b*r+T*l+D*p-(E*r+M*l+F*p),K=A*r+P*l+F*f-(R*r+L*l+D*f),$=1/(s*W+h*X+d*q+w*K);return e[0]=$*W,e[1]=$*X,e[2]=$*q,e[3]=$*K,e[4]=$*(y*h+b*d+A*w-(_*h+E*d+R*w)),e[5]=$*(_*s+T*d+P*w-(y*s+M*d+L*w)),e[6]=$*(E*s+M*h+F*w-(b*s+T*h+D*w)),e[7]=$*(R*s+L*h+D*d-(A*s+P*h+F*d)),e[8]=$*(S*c+k*g+B*v-(z*c+N*g+C*v)),e[9]=$*(z*a+I*g+Y*v-(S*a+U*g+V*v)),e[10]=$*(N*a+U*c+O*v-(k*a+I*c+j*v)),e[11]=$*(C*a+V*c+j*g-(B*a+Y*c+O*g)),e[12]=$*(N*m+C*x+z*u-(B*x+S*u+k*m)),e[13]=$*(V*x+S*n+U*m-(I*m+Y*x+z*n)),e[14]=$*(I*u+j*x+k*n-(O*x+N*n+U*u)),e[15]=$*(O*m+B*n+Y*u-(V*u+j*m+C*n)),t}multiplyVector(t){let e=new Array(3);for(var i=0;i<3;++i){e[i]=0;for(var s=0;s<4;++s)e[i]+=t.item(s)*this.get(s,i)}return new c(e[0],e[1],e[2])}multipliedVectorList(t){let e=Array(t.length);for(let i=0;i<t.length;i++)e[i]=this.multiplyVector(t[i]);return e}}class a{rotateX(t){let e=o.newXRotation(t);return this.transform(e)}rotateY(t){let e=o.newYRotation(t);return this.transform(e)}rotateZ(t){let e=o.newZRotation(t);return this.transform(e)}rotate(t,e){let i=o.newAxisRotation(e,t);return this.transform(i)}move(t){let e=o.newTranslate(t);return this.transform(e)}scale(t){let e=o.newScaler(t.x,t.y,t.z);return this.transform(e)}rotatedX(t){let e=o.newXRotation(t);return this.transformed(e)}rotatedY(t){let e=o.newYRotation(t);return this.transformed(e)}rotatedZ(t){let e=o.newZRotation(t);return this.transformed(e)}rotated(t,e){let i=o.newAxisRotation(e,t);return this.transformed(i)}moved(t){let e=o.newTranslate(t);return this.transformed(e)}scaled(t){let e=o.newScaler(t.x,t.y,t.z);return this.transformed(e)}}class h extends a{constructor(t){super(),this.matrix=t}static new(t){return new h(new n(t,2))}static fromList(t){let e=t.length,i=h.new(e);for(let e=0;e<t.length;e++)i.matrix.set(e,0,t[e].x),i.matrix.set(e,1,t[e].y);return i}static fromMatrix(t){if(2!=t.width)throw new Error("incorrect.");return new h(t)}static fromData(t){let e=h.new(t.length/2);return e.matrix.fillWith(t),e}get width(){return this.matrix.width}get height(){return this.matrix.height}get dimensions(){return this.matrix.width}get count(){return this.matrix.height}forEach(t){for(let e=0;e<this.count;e++){let i=this.get(e);t(i,e),this.set(e,i)}return this}map(t){let e=this.clone();for(let i=0;i<this.count;i++){let s=this.get(i),r=t(s,i);r instanceof f?e.set(i,r):e.set(i,s)}return e}set(t,e){this.matrix.data[t*this.matrix.width+0]=e.x,this.matrix.data[t*this.matrix.width+1]=e.y}setXY(t,e,i){this.matrix.data[t*this.matrix.width+0]=e,this.matrix.data[t*this.matrix.width+1]=i}get(t){return new f(this.matrix.data[t*this.width+0],this.matrix.data[t*this.width+1])}toMatrixSlice(){return this.matrix}toList(){let t=[];for(let e=0;e<this.height;e++)t.push(this.get(e));return t}to3D(){let t=l.new(this.count);for(let e=0;e<this.count;e++){let i=this.matrix.getRow(e);t.setXYZ(e,i[0],i[1],0)}return t}clone(){let t=h.new(this.count);return t.matrix=this.matrix.clone(),t}transform(t){return this.matrix.multiply(t),this}transformed(t){let e=h.new(this.count);return e.matrix=this.matrix.multiplied(t),e}}class l extends a{constructor(t){super(),this.matrix=t}static new(t){return new l(new n(t,3))}static fromList(t){let e=t.length,i=l.new(e);return i.fillFromList(t),i}static fromNative(t){return new l(n.fromNative(t))}static fromData(t){let e=l.new(t.length/2);return e.matrix.fillWith(t),e}static fromMatrix(t){if(3!=t.width)throw new Error("incorrect.");return new l(t)}get width(){return this.matrix.width}get height(){return this.matrix.height}get dimensions(){return this.matrix.width}get count(){return this.matrix.height}setXYZ(t,e,i,s){this.matrix.data[t*this.width+0]=e,this.matrix.data[t*this.width+1]=i,this.matrix.data[t*this.width+2]=s}set(t,e){this.matrix.data[t*this.width+0]=e.x,this.matrix.data[t*this.width+1]=e.y,this.matrix.data[t*this.width+2]=e.z}get(t){return new c(this.matrix.data[t*this.width+0],this.matrix.data[t*this.width+1],this.matrix.data[t*this.width+2])}slice(){return this.matrix}fillFromList(t){for(let e=0;e<t.length;e++)this.set(e,t[e])}forEach(t){for(let e=0;e<this.count;e++){let i=this.get(e);i=t(i,e),i instanceof c&&this.set(e,i)}return this}take(t){const e=t.length;let i=l.new(e);for(let s=0;s<e;s++){let e=t[s];i.set(s,this.get(e))}return i}takeRange(t,e){let i=l.new(e-t),s=0;for(let r=t;r<e;r++)i.set(s,this.get(r)),s++;return i}map(t){let e=this.clone();for(let i=0;i<this.count;i++){let s=this.get(i),r=t(s,i);r instanceof c?e.set(i,r):e.set(i,s)}return e}mapWith(t,e){let i=this.matrix.mapWith(t.matrix,e);return new l(i)}toList(){let t=[];for(let e=0;e<this.height;e++)t.push(this.get(e));return t}to2D(){return h.fromMatrix(this.matrix)}mean(){let t=c.zero(),e=this.count;for(let i=0;i<e;i++)t.x+=this.matrix.data[3*i],t.y+=this.matrix.data[3*i+1],t.z+=this.matrix.data[3*i+2];return t.scale(1/e)}average(){return this.mean()}closestId(t){let e=1/0,i=-1;return this.forEach(((s,r)=>{let n=t.disToSquared(s);n<e&&(e=n,i=r)})),i}closestIds(t,e){let i=[];for(let s=0;s<e;s++){let e=1/0,s=-1;this.forEach(((r,n)=>{if(i.includes(s))return;let o=t.disToSquared(r);o<e&&(e=o,s=n)})),i.push(s)}return i}clone(){return new l(this.matrix.clone())}transform(t){for(let e=0;e<this.height;e++){let i=this.get(e);i=t.multiplyVector(i),this.set(e,i)}return this}move(t){for(let e=0;e<this.height;e++){let i=this.get(e);i.add(t),this.set(e,i)}return this}scale(t){for(let e=0;e<this.height;e++){let i=this.get(e);i.mul(t),this.set(e,i)}return this}transformed(t){return new l(function(t,e){let i=new n(t.height,e.width);for(var s=0;s<t.height;s++)for(var r=0;r<4;r++){for(var o=0;o<3;o++)i.set(s,r,i.get(s,r)+t.get(s,o)*e.get(o,r));i.set(s,r,i.get(s,r)+1*e.get(3,r))}return i}(this.matrix,t))}moved(t){let e=o.newTranslate(t);return this.transformed(e)}scaled(t){let e=o.newScaler(t.x,t.y,t.z);return this.transformed(e)}}class u{static range(t){let e=[];for(let i=0;i<t;i++)e.push(i);return e}static collect(t){let e=new Array;for(let i of t)e.push(i);return e}static lowestScore(t,e,i=1e-10){let s=1/0;for(;t.t1-t.t0>i;)s=(t.t1+t.t0)/2,e(s-i)<e(s+i)?t.t1=s:t.t0=s;return s}static lowestScoreSquared(t,e,i=1e-10){let s=1/0,r=1/0;for(;t.x.t1-t.x.t0>i||t.y.t1-t.y.t0>i;)s=(t.x.t1+t.x.t0)/2,r=(t.y.t1+t.y.t0)/2,e(s-i,r)<e(s+i,r)?t.x.t1=s:t.x.t0=s,e(s,r-i)<e(s,r+i)?t.y.t1=r:t.y.t0=r;return f.new(s,r)}static iterateTriangle(e,i){return t.stack(e)+i}static getTriangleBase(t,e){let i=l.new(e),s=e-1,r=0;for(let e=0;e<=s;e++){let n=u.iterateTriangle(s,e);i.set(r,t.get(n)),r++}return i}static getTriangleLeft(t,e){let i=l.new(e),s=0;for(let r=e-1;r>-1;r-=1)i.set(s,t.get(u.iterateTriangle(r,0))),s++;return i}static getTriangleRight(t,e){let i=l.new(e),s=0;for(let r=e-1;r>-1;r-=1)i.set(s,t.get(u.iterateTriangle(r,r))),s++;return i}}class c{constructor(t,e,i){this.x=t,this.y=e,this.z=i}static new(t=0,e=0,i=0){return new c(t,e,i)}static calculateWheelOrder(t,e,i){let s=[];t.forEach((t=>{s.push(new f(t.dot(e),t.dot(i)).angle())}));let r=u.range(t.length);return r.sort(((t,e)=>s[t]-s[e])),r}static fromLerp(t,e,i){return new c(t.x+(e.x-t.x)*i,t.y+(e.y-t.y)*i,t.z+(e.z-t.z)*i)}static fromArray(t){return new c(t[0],t[1],t[2])}static fromRandom(t){return new c(t.get(),t.get(),t.get())}static fromRandomUnit(t){return this.fromRandom(t).sub(c.new(.5,.5,.5)).normalize()}static fromSphere(t,e,i){const s=Math.sin(i)*t;return this.constructor(s*Math.sin(e),Math.cos(i)*t,s*Math.cos(e))}static fromCylinder(t,e,i){return this.constructor(t*Math.sin(e),i,t*Math.cos(e))}static fromLerpWeights(t,e,i,s,r){if(Math.abs(r-i)<1e-5)return t;if(Math.abs(r-s)<1e-5)return e;if(Math.abs(i-s)<1e-5)return t;let n=(r-i)/(s-i);return new c(t.x+n*(e.x-t.x),t.y+n*(e.y-t.y),t.z+n*(e.z-t.z))}static zero(){return new c(0,0,0)}static unitX(){return new c(1,0,0)}static unitY(){return new c(0,1,0)}static unitZ(){return new c(0,0,1)}toArray(){return new Float32Array([this.x,this.y,this.z])}set(t,e,i){return this.x=t,this.y=e,this.z=i,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}toString(){return`Vector3(${this.x}, ${this.y}, ${this.z})`}toVector2(){return new f(this.x,this.y)}clone(){return new c(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}to2D(){return new f(this.x,this.y)}largestValue(){return Math.max(this.x,this.y,this.z)}added(t){return new c(this.x+t.x,this.y+t.y,this.z+t.z)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}subbed(t){return new c(this.x-t.x,this.y-t.y,this.z-t.z)}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}item(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return 1;default:throw"nope"}}scaled(t){return new c(this.x*t,this.y*t,this.z*t)}scale(t){return this.x*=t,this.y*=t,this.z*=t,this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplied(t){return new c(this.x*t.x,this.y*t.y,this.z*t.z)}divVector(t){return new c(this.x/t.x,this.y/t.y,this.z/t.z)}divided(t){return new c(this.x/t,this.y/t,this.z/t)}div(t){return this.x/=t,this.y/=t,this.z/=t,this}minimumed(t){return new c(Math.min(this.x,t.x),Math.min(this.y,t.y),Math.min(this.z,t.z))}maximumed(t){return new c(Math.max(this.x,t.x),Math.max(this.y,t.y),Math.max(this.z,t.z))}clamped(t,e){return new c(Math.max(t.x,Math.min(e.x,this.x)),Math.max(t.y,Math.min(e.y,this.y)),Math.max(t.z,Math.min(e.z,this.z)))}clampScalared(e,i){return new c(t.clamp(this.x,e,i),t.clamp(this.y,e,i),t.clamp(this.z,e,i))}clampLengthed(t,e){const i=this.length();return this.div(i||1).scale(Math.max(t,Math.min(e,i)))}floored(){return new c(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))}ceiled(){return new c(Math.ceil(this.x),Math.ceil(this.y),Math.ceil(this.z))}rounded(){return new c(Math.round(this.x),Math.round(this.y),Math.round(this.z))}roundedToZero(){return new c(this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z<0?Math.ceil(this.z):Math.floor(this.z))}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}negated(){return new c(-this.x,-this.y,-this.z)}angle(t,e){let i=this.subbed(e.scaled(this.dot(e))),s=t.subbed(e.scaled(t.dot(e)));return console.log(i),console.log(s),0}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){const e=this.x,i=this.y,s=this.z,r=t.x,n=t.y,o=t.z;return new c(i*o-s*n,s*r-e*o,e*n-i*r)}getLengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.getLengthSquared())}manhat(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.div(this.length()||1)}normalized(){return this.divided(this.length()||1)}isNormal(){return Math.abs(this.length()-1)<r.TOLERANCE}disTo(t){return Math.sqrt(this.disToSquared(t))}disToSquared(t){const e=this.x-t.x,i=this.y-t.y,s=this.z-t.z;return e*e+i*i+s*s}disToManhat(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setLength(t){return this.normalize().scale(t)}lerp(t,e){return c.fromLerp(this,t,e)}projectOnVector(t){const e=t.getLengthSquared();if(0===e)return this.set(0,0,0);const i=t.dot(this)/e;return this.copy(t).scale(i)}projectedOnPlane(t){return d.copy(this).projectOnVector(t),this.minimumed(d)}mirrored(t){return this.minimumed(d.copy(t).scale(2*this.dot(t)))}rotated(t,e){return o.newAxisRotation(t,e).multiplyVector(this)}}const d=new c(0,0,0);class f{constructor(t,e){this.x=t,this.y=e}static new(t=0,e=0){return new f(t,e)}static fromArray(t){return new f(t[0],t[1])}static fromLerp(t,e,i){return new f(t.x+(e.x-t.x)*i,t.y+(e.y-t.y)*i)}static fromRandom(t){return new f(t.get(),t.get())}static fromRandomAngle(){let t=Math.random()*Math.PI*2;return new f(Math.cos(t),Math.sin(t))}static fromCircle(t,e,i){return new f(t.x+e*Math.sin(i),t.y+e*Math.cos(i))}static fromCopy(t){return this.zero().copy(t)}static zero(){return new f(0,0)}static NaN(){return new f(NaN,NaN)}static fromCircumcenter(t,e,i){const s=t.squareSum(),r=e.squareSum(),n=i.squareSum();let o=2*(t.x*(e.y-i.y)+e.x*(i.y-t.y)+i.x*(t.y-e.y));if(o<1e-6)return f.NaN();let a=(s*(e.y-i.y)+r*(i.y-t.y)+n*(t.y-e.y))/o,h=(s*(i.x-e.x)+r*(t.x-i.x)+n*(e.x-t.x))/o;return new f(a,h)}static getSign(t,e,i){return(t.x-i.x)*(e.y-i.y)-(e.x-i.x)*(t.y-i.y)}to3D(){return new c(this.x,this.y,0)}set(t,e){return this.x=t,this.y=e,this}roughlyEquals(t,e){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e}equals(t){return t.x===this.x&&t.y===this.y}toString(){return`Vector2(${this.x}, ${this.y})`}clone(){return new f(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}added(t){return new f(this.x+t.x,this.y+t.y)}addn(t,e){return this.x+=t,this.y+=e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subbed(t){return new f(this.x-t.x,this.y-t.y)}mul(t){return this.x*=t.x,this.y*=t.y,this}scale(t){return this.x*=t,this.y*=t,this}scaled(t){return new f(this.x*t,this.y*t)}divVector(t){return this.x/=t.x,this.y/=t.y,this}div(t){return this.x/=t,this.y/=t,this}dived(t){return new f(this.x/t,this.y/t)}minimum(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}maximum(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const i=this.length();return this.div(i||1).scale(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}squareSum(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this.x*this.x+this.y*this.y}manhat(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.div(this.length()||1)}normalized(){return this.dived(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}disTo(t){return Math.sqrt(this.disToSquared(t))}disToSquared(t){let e=this.x-t.x,i=this.y-t.y;return e*e+i*i}disToManhat(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().scale(t)}lerp(t,e){return new f(this.x+(t.x-this.x)*e,this.y+(t.y-this.y)*e)}sign(t,e){return(this.x-e.x)*(t.y-e.y)-(t.x-e.x)*(this.y-e.y)}projectOnVector(t){const e=t.lengthSquared();if(0===e)return this.set(0,0);const i=t.dot(this)/e;return this.copy(t).scale(i)}}class m{constructor(t=0,e=1){this.t0=t,this.t1=e}static new(t=0,e=1){return new m(t,e)}static fromRadius(t){return new m(-t,t)}static fromInclude(t){let e=Number.MAX_VALUE,i=Number.MIN_VALUE;for(let s=0;s<t.length;s++)t[s]<e&&(e=t[s]),t[s]>i&&(i=t[s]);return new m(e,i)}offset(t,e){return this.t0+=t,this.t1+=e,this}includes(t){return t>=this.t0&&t<=this.t1}size(){return this.t1-this.t0}normalize(t){return(t-this.t0)/this.size()}elevate(t){return t*this.size()+this.t0}lerp(t){return this.elevate(t)}remap(t,e=new m){let i=this.normalize(t);return e.elevate(i)}spawn(t){let e=new Float32Array(t),i=this.size()/(t-1);for(let s=0;s<t;s++)e[s]=this.t0+s*i;return e}*iter(t){let e=this.size()/(t-1);for(let i=0;i<t;i++){let t=this.t0+i*e;yield t}}*iterStep(t){for(let e=this.t0;e<=this.t1;e+=t)yield e}comform(t){return t<this.t0?this.t0:t>this.t1?this.t1:t}}class g{constructor(t=new m,e=new m){this.x=t,this.y=e}static fromRadii(t,e){return new g(m.fromRadius(t),m.fromRadius(e))}static fromRadius(t){return new g(m.fromRadius(t),m.fromRadius(t))}static fromBounds(t,e,i,s){return new g(new m(t,e),new m(i,s))}static fromInclude(t){let e=t.toMatrixSlice();return new g(m.fromInclude(e.getColumn(0)),m.fromInclude(e.getColumn(1)))}offset(t){let e=t;if(4!=e.length)throw"need 4 values";return this.x.offset(e[0],e[1]),this.y.offset(e[2],e[3]),this}includes(t){return this.x.includes(t.x)&&this.y.includes(t.y)}size(){return new f(this.x.size(),this.y.size())}normalize(t){return new f(this.x.normalize(t.x),this.y.normalize(t.y))}elevate(t){return new f(this.x.elevate(t.x),this.y.elevate(t.y))}remap(t,e=new g){let i=this.normalize(t);return e.elevate(i)}corners(){Math.pow(2,2);let t=[];for(let e of[this.x.t0,this.x.t1])for(let i of[this.y.t0,this.y.t1])t.push(new f(e,i));return t}spawn(t,e){let i=h.new(t*e),s=0,r=this.y.spawn(e),n=this.x.spawn(t);for(const t of r)for(const e of n)i.setXY(s,e,t),s++;return i}populate(t,e){let i=h.new(t);for(let t=0;t<i.count;t++)i.set(t,this.elevate(f.fromRandom(e)));return i}}class w{constructor(t){this.globalContext=t,this.currentContext=t}toggleVisibility(){this.globalContext.hidden?this.show():this.hide()}hide(){this.globalContext.hidden=!0}show(){this.globalContext.hidden=!1}addContext(t){this.currentContext=this.globalContext;let e=this.addDiv(t+" app-interface");this.currentContext=e}setContext(t){this.globalContext.getElementsByClassName(t)}removeContext(t){this.setContext(t);for(let t=this.currentContext.childElementCount-1;t>=0;t-=1)this.currentContext.removeChild(this.currentContext.children.item(t));let e=this.currentContext;this.currentContext=this.globalContext,this.currentContext.removeChild(e)}addElement(t,e=""){let i=document.createElement(t);return i.className=e,this.currentContext.appendChild(i),i}addDiv(t,e=[]){let i=this.addElement("div",t);return e.forEach((t=>{i.appendChild(t)})),i}addBooleanParameter(t,e=(()=>{})){let i=this.addElement("input","checkbox");i.type="checkbox",i.addEventListener("change",(()=>{let s=i.checked;t.set(s?1:0),e(i.valueAsNumber),n.innerText=t.name})),i.checked=1==t.get();let s=this.addElement("label","check-container"),r=this.addElement("span","checkmark");s.appendChild(i),s.appendChild(r);let n=this.addElement("p","control-text");return n.innerText=t.name,this.addDiv("control",[n,s]),i}addParameter(t,e=(()=>{})){let i;i=t instanceof x?t.p:t;let s=this.addRangeInput(i,e),r=this.addElement("p","control-text");r.innerText=i.name;let n=this.addElement("p","control-value");return n.innerText=t instanceof x?t.getName():s.value,this.addDiv("control",[r,s,n]),t.setSliderAndText(s,n),s.oninput=()=>{i.set(s.valueAsNumber,!1),e(s.valueAsNumber),n.innerText=t instanceof x?t.getName():s.value},s}addRangeInput(t,e=(()=>{})){let i=this.addElement("input","control-slider");return i.type="range",i.min=t.min.toString(),i.max=t.max.toString(),i.valueAsNumber=t.state,i.step=t.step.toString(),i}addText(t){this.addElement("p","ui-text").innerText=t}addButton(t,e){let i=this.addElement("button","control-button");i.innerText=t,i.addEventListener("click",e);let s=this.addElement("p","control-text");return this.addDiv("control",[s,i])}addDropdown(t,e){let i=t.values.length,s=this.addElement("select","enum-selector dropdown-select");for(let e=0;e<i;e++){let i=this.addElement("option","enum-item");i.innerText=t.values[e],s.appendChild(i)}return s.addEventListener("change",(i=>{let s=i.target.selectedIndex;t.set(s),e(s)})),this.addDiv("dropdown-dark",[s]),s}}class p{constructor(t,e,i=-1/0,s=1/0,r=.1){this.name=t,this.min=i,this.max=s,this.step=r,this.state=e,this.set(this.state)}static new(t,e,i=-1/0,s=1/0,r=.1){return new p(t,e,i,s,r)}static newBoolean(t,e){return new p(t,e?1:0,0,1,1)}get(){return this.state}getDomain(){return m.new(this.min,this.max)}set(e,i=!0){t.clamp(e,this.min,this.max);let s=e-this.min,r=Math.round(s/this.step),n=this.min+this.step*r;this.state=t.clamp(n,this.min,this.max),i&&this.onset()}getNPermutations(){return Math.min((this.max-this.min)/this.step+1)}setSlider(t){this.slider=t}setSliderAndText(t,e){this.slider=t,this.text=e}onset(){this.slider&&(this.slider.valueAsNumber=this.state),this.text&&(this.text.innerText=this.state.toString())}}class x{constructor(t,e){this.p=t,this.values=e}static new(t,e,i){return new x(new p(t,e,0,i.length-1,1),i)}getName(){return this.values[this.get()]}get(){return this.p.get()}set(t){return this.p.set(t)}getNPermutations(){return this.p.getNPermutations()}setSlider(t){this.slider=t}setSliderAndText(t,e){this.slider=t,this.text=e}onset(){this.slider&&(this.slider.valueAsNumber=this.get()),this.text&&(this.text.innerText=this.getName())}}class v{constructor(){this.data=new Map}stringify(t){return t.toString()}set(t,e){return this.data.set(this.stringify(t),e)}has(t){return this.data.has(this.stringify(t))}get(t){return this.data.get(this.stringify(t))}}class _{constructor(t,e,i=[]){this._height=t,this._width=e,this.data=new Uint16Array(this._width*this._height),i==[]||0==i.length?this.fill(0):this.setData(i)}static fromList(t,e){let i=t.length/e,s=new _(i,e);for(let e=0;e<t.length;e++)s.data[e]=t[e];return s}print(){let t=[];for(var e=0;e<this._height;e++){t.push("|");for(var i=0;i<this._width;i++){let s=this.get(e,i).toFixed(2);s=s.padStart(8," "),t.push(s),i<this._width-2&&t.push("  ")}t.push("  |\n")}console.log(t.join(""))}clone(){let t=new _(this._height,this._width);return t.data=this.data,t}setData(t){if(t.length!=this._height*this._width)throw"data.length does not match width * height "+t.length.toString();this.data.set(t)}count(){return this._height}getDimensions(){return[this._height,this._width]}inRange(t,e){return!(t<0||t>this._height-1||e<0||e>this._width-1)}fill(t){let e=this._height*this._width;for(let i=0;i<e;i++)this.data[i]=t}fillWith(t,e=this._width){let i=e;if(i>this._width)throw"values per entry is larger than this._width. This will spill over.";for(let e=0;e<this._height;e++)for(let s=0;s<i;s++)this.set(e,s,t[e*i+s])}get(t,e){return this.inRange(t,e)?this.data[t*this._width+e]:(console.warn("out of range!"),0)}getRow(t){let e=new Uint16Array(this._width);for(let i=0;i<this._width;i++)e[i]=this.get(t,i);return e}getColumn(t){let e=new Uint16Array(this._height);for(let i=0;i<this._height;i++){let s=i*this._width+t;e[i]=this.data[s]}return e}set(t,e,i){this.inRange(t,e)?this.data[t*this._width+e]=i:console.warn("out of range!")}setRow(t,e){for(let i=0;i<this._width;i++)this.set(t,i,e[i])}takeRows(t){console.log(this._height,this._width);const e=t.length;let i=new _(e,this._width);for(let s=0;s<e;s++){let e=t[s];i.setRow(s,this.getRow(e))}return i}getData(){return this.data}forEachValue(t){for(let e=0;e<this.data.length;e++)this.data[e]=t(this.data[e],e);return this}forEachRow(t){for(let e=0;e<this._height;e++){let i=this.getRow(e);t(i,e),this.setRow(e,i)}return this}trueForAll(t){for(let e=0;e<this.data.length;e++)if(!t(this.data[e],e))return!1;return!0}}function y(t){return t instanceof n?t:t instanceof h?t.toMatrixSlice():t instanceof l?t.slice():t[0]instanceof f?h.fromList(t).toMatrixSlice():l.fromList(t).slice()}class b{constructor(t,e){this.verts=y(t),this.links=null==e?E(this.verts.height):e}static fromLines(t){let e=y(t);return new b(e)}static fromMesh(t,e=!1){let i=t.mesh,s=6*i.links.count(),r=new Uint16Array(s);for(let t=0;t<i.links.count();t++){let e=6*t;r[e]=i.links.get(t,0),r[e+1]=i.links.get(t,1),r[e+2]=i.links.get(t,1),r[e+3]=i.links.get(t,2),r[e+4]=i.links.get(t,2),r[e+5]=i.links.get(t,0)}return new b(e?t.uvs.toMatrixSlice():i.verts.slice(),r)}static fromGrid(t,e,i){let s=(e-1)*i/2,r=l.new(4*e);for(let t=0;t<e;t++){let e=i*t-s;r.set(2*t,new c(e,-s,0)),r.set(2*t+1,new c(e,s,0))}for(let t=0;t<e;t++)r.set(2*e+2*t,new c(-s,i*t-s,0)),r.set(2*e+2*t+1,new c(s,i*t-s,0));return r.forEach((e=>t.pushToWorld(e))),new b(r.slice())}static fromPlane(t){let e=r.PLANE_RENDER_LINECOUNT,i=r.PLANE_RENDER_LINEDISTANCE,s=i/10,n=(e-1)*i/2,o=l.new(4*e+10);for(let t=0;t<e;t++){let e=i*t-n;o.set(2*t,new c(e,-n,0)),o.set(2*t+1,new c(e,n,0))}for(let t=0;t<e;t++)o.set(2*e+2*t,new c(-n,i*t-n,0)),o.set(2*e+2*t+1,new c(n,i*t-n,0));let a=o.count-10;o.set(a,new c(n+s,-s,0)),o.set(a+1,new c(n+4*s,s,0));let h=o.count-8;o.set(h,new c(n+s,s,0)),o.set(h+1,new c(n+4*s,-s,0));let u=o.count-6;o.set(u,new c(0,n+2.5*s,0)),o.set(u+1,new c(s,n+4*s,0));let d=o.count-4;o.set(d,new c(s,n+s,0)),o.set(d+1,new c(-s,n+4*s,0));let f=o.count-2;return o.set(f,new c(0,0,0)),o.set(f+1,new c(0,0,i)),o.forEach((e=>t.pushToWorld(e))),new b(o.slice())}static fromCircle(t,e=r.CIRCLE_SEGMENTS){let i=e,s=l.new(i);for(let e=0;e<i;e++){let r=e/i*(2*Math.PI);s.set(e,t.plane.pushToWorld(new c(Math.cos(r)*t.radius,Math.sin(r)*t.radius,0)))}return new b(s.slice(),R(i,!0))}static fromPolyline(t){return new b(t.verts,R(t.verts.count,!1))}static fromBezier(t,e=r.BEZIER_SEGMENTS){let i=e+1,s=l.new(i);for(let r=0;r<i;r++){let i=r/e;s.set(r,t.pointAt(i))}return new b(s.slice(),R(i,!1))}static fromCube(t){let e=l.fromList(t.getCorners());return new b(e)}static fromJoin(t){let e=0,i=0;for(let s of t)e+=s.links.length,i+=s.verts.count();let s=l.new(i),r=new Uint16Array(e),n=0,o=0;for(let e of t){for(let t=0;t<e.verts.count();t++)s.slice().setRow(n+t,e.verts.getRow(t));for(let t=0;t<e.links.length;t++)r[o+t]=e.links[t]+n;n+=e.verts.count(),o+=e.links.length}return new b(s,r)}}function E(t){let e=new Uint16Array(t);for(let i=0;i<t;i++)e[i]=i;return e}function R(t,e){let i=2*t;e||(i-=2);let s=new Uint16Array(i);for(let e=0;e<t;e++)s[2*e]=e,s[2*e+1]=(e+1)%t;return s}class A{constructor(t,e){this.origin=t,this.normal=e.normalize()}static fromNormal(t,e){return new A(t,e)}static fromPoints(t,e){return new A(t,e.subbed(t).normalize())}at(t){return this.origin.added(this.normal.scaled(t))}xPlane(t){return-(this.origin.dot(t.normal)+t.d)/this.normal.dot(t.normal)}toLine(t){let e=this.at(t);return b.fromLines([this.origin,e])}}class M{static sum(t){let e=0;for(let i=0;i<t.length;i++)e+=t[i];return e}static mean(t){return this.sum(t)/t.length}static meanWeighted(t,e){if(t.length!=e.length)throw new Error("values & weights need same length");var i=0,s=0;for(let r=0;r<t.length;r++)i+=t[r]*e[r],s+=e[r];return i/s}static variance(t){let e=t.length,i=this.mean(t),s=0;for(let r=0;r<e;r++)s+=Math.pow(t[r]-i,2);return s/(e-1)}static deviation(t){return Math.pow(this.variance(t),.5)}static covariance(t,e){if(t.length!=e.length)throw"this is not how covariance works...";let i=t.length,s=this.mean(t),r=this.mean(e),n=0;for(let o=0;o<i;o++)n+=(t[o]-s)*(e[o]-r);return n/(i-1)}static cov(t){let e=t.width,i=new n(e,e),s=Array(e);for(let i=0;i<e;i++)s[i]=t.getColumn(i);for(let t=0;t<e;t++)for(let r=t;r<e;r++){let e=this.covariance(s[t],s[r]);i.set(t,r,e),i.set(r,t,e)}return i}static eig(t){let e=this.svd(t);return[e[1],e[2]]}static svd(t){var e=Math.pow(2,-52),i=1e-64/e,s=0,r=0,o=0,a=0,h=0,l=t.clone().toNative(),u=l.length,c=l[0].length;if(u<c)throw"Need more rows than columns";var d=new Array(c),f=new Array(c);for(r=0;r<c;r++)d[r]=f[r]=0;var m=function t(e,i,s=0){let r,n=e[s],o=Array(n);if(s===e.length-1){for(r=n-2;r>=0;r-=2)o[r+1]=i,o[r]=i;return-1===r&&(o[0]=i),o}for(r=n-1;r>=0;r--)o[r]=t(e,i,s+1);return o}([c,c],0);function g(t,e){return(t=Math.abs(t))>(e=Math.abs(e))?t*Math.sqrt(1+e*e/t/t):0==e?t:e*Math.sqrt(1+t*t/e/e)}var w,p=0,x=0,v=0,_=0,y=0,b=0,E=0;for(r=0;r<c;r++){for(d[r]=x,E=0,h=r+1,o=r;o<u;o++)E+=l[o][r]*l[o][r];if(E<=i)x=0;else for(p=l[r][r],x=Math.sqrt(E),p>=0&&(x=-x),v=p*x-E,l[r][r]=p-x,o=h;o<c;o++){for(E=0,a=r;a<u;a++)E+=l[a][r]*l[a][o];for(p=E/v,a=r;a<u;a++)l[a][o]+=p*l[a][r]}for(f[r]=x,E=0,o=h;o<c;o++)E+=l[r][o]*l[r][o];if(E<=i)x=0;else{for(p=l[r][r+1],x=Math.sqrt(E),p>=0&&(x=-x),v=p*x-E,l[r][r+1]=p-x,o=h;o<c;o++)d[o]=l[r][o]/v;for(o=h;o<u;o++){for(E=0,a=h;a<c;a++)E+=l[o][a]*l[r][a];for(a=h;a<c;a++)l[o][a]+=E*d[a]}}(y=Math.abs(f[r])+Math.abs(d[r]))>_&&(_=y)}for(r=c-1;-1!=r;r+=-1){if(0!=x){for(v=x*l[r][r+1],o=h;o<c;o++)m[o][r]=l[r][o]/v;for(o=h;o<c;o++){for(E=0,a=h;a<c;a++)E+=l[r][a]*m[a][o];for(a=h;a<c;a++)m[a][o]+=E*m[a][r]}}for(o=h;o<c;o++)m[r][o]=0,m[o][r]=0;m[r][r]=1,x=d[r],h=r}for(r=c-1;-1!=r;r+=-1){for(h=r+1,x=f[r],o=h;o<c;o++)l[r][o]=0;if(0!=x){for(v=l[r][r]*x,o=h;o<c;o++){for(E=0,a=h;a<u;a++)E+=l[a][r]*l[a][o];for(p=E/v,a=r;a<u;a++)l[a][o]+=p*l[a][r]}for(o=r;o<u;o++)l[o][r]=l[o][r]/x}else for(o=r;o<u;o++)l[o][r]=0;l[r][r]+=1}for(e*=_,a=c-1;-1!=a;a+=-1)for(var R=0;R<50;R++){var A=!1;for(h=a;-1!=h;h+=-1){if(Math.abs(d[h])<=e){A=!0;break}if(Math.abs(f[h-1])<=e)break}if(!A){s=0,E=1;var M=h-1;for(r=h;r<a+1&&(p=E*d[r],d[r]=s*d[r],!(Math.abs(p)<=e));r++)for(v=g(p,x=f[r]),f[r]=v,s=x/v,E=-p/v,o=0;o<u;o++)y=l[o][M],b=l[o][r],l[o][M]=y*s+b*E,l[o][r]=-y*E+b*s}if(b=f[a],h==a){if(b<0)for(f[a]=-b,o=0;o<c;o++)m[o][a]=-m[o][a];break}if(R>=49)throw"Error: no convergence.";for(_=f[h],x=g(p=(((y=f[a-1])-b)*(y+b)+((x=d[a-1])-(v=d[a]))*(x+v))/(2*v*y),1),p=p<0?((_-b)*(_+b)+v*(y/(p-x)-v))/_:((_-b)*(_+b)+v*(y/(p+x)-v))/_,s=1,E=1,r=h+1;r<a+1;r++){for(x=d[r],y=f[r],v=E*x,x*=s,b=g(p,v),d[r-1]=b,p=_*(s=p/b)+x*(E=v/b),x=-_*E+x*s,v=y*E,y*=s,o=0;o<c;o++)_=m[o][r-1],b=m[o][r],m[o][r-1]=_*s+b*E,m[o][r]=-_*E+b*s;for(b=g(p,v),f[r-1]=b,p=(s=p/b)*x+(E=v/b)*y,_=-E*x+s*y,o=0;o<u;o++)y=l[o][r-1],b=l[o][r],l[o][r-1]=y*s+b*E,l[o][r]=-y*E+b*s}d[h]=0,d[a]=p,f[a]=_}for(r=0;r<f.length;r++)f[r]<e&&(f[r]=0);for(r=0;r<c;r++)for(o=r-1;o>=0;o--)if(f[o]<f[r]){for(s=f[o],f[o]=f[r],f[r]=s,a=0;a<l.length;a++)w=l[a][r],l[a][r]=l[a][o],l[a][o]=w;for(a=0;a<m.length;a++)w=m[a][r],m[a][r]=m[a][o],m[a][o]=w;r=o}return[n.fromNative(l),new Float32Array(f),n.fromNative(m)]}}class T{constructor(t){this._matrix=t}static fromPN(t,e){let i=e.cross(c.unitX());i.length()<r.TOLERANCE&&(i=e.cross(c.unitY()));let s=i.normalize(),n=e.cross(s).normalize(),o=T.planeMatrixFromVecs(t,s,n,e);return new T(o)}static fromPVV(t,e,i){let s=e.clone().cross(i).normalize(),r=t.clone(),n=e.normalize(),o=e.clone().cross(s),a=T.planeMatrixFromVecs(r,n,o,s);return new T(a)}static from3pt(t,e,i){let s=e.clone().sub(t),r=i.clone().sub(t);return this.fromPVV(t,s,r)}static WorldXY(){return T.from3pt(c.zero(),c.unitX(),c.unitY())}static WorldYZ(){return T.from3pt(c.zero(),c.unitY(),c.unitZ())}static WorldXZ(){return T.from3pt(c.zero(),c.unitX(),c.unitZ())}static fromLeastSquares(t){let e=t.mean(),i=M.cov(t.slice()),[s,r]=M.eig(i);console.log(s);let n=c.fromArray(r.getColumn(0)),o=c.fromArray(r.getColumn(1));return T.fromPVV(e,n,o)}static fromXYLeastSquares(t){let e=t.mean();return T.WorldXY().transform(o.newTranslation(e.x,e.y,e.z))}static planeMatrixFromVecs(t,e,i,s){return new o([e.x,e.y,e.z,0,i.x,i.y,i.z,0,s.x,s.y,s.z,0,t.x,t.y,t.z,1])}get ihat(){return c.fromArray(this._matrix.getRow(0))}get jhat(){return c.fromArray(this._matrix.getRow(1))}get khat(){return c.fromArray(this._matrix.getRow(2))}get center(){return c.fromArray(this._matrix.getRow(3))}get matrix(){return this._matrix.clone()}get normal(){return this.khat}get d(){return this.closestPoint(c.zero())[1]}set ihat(t){this._matrix.setRow(0,[t.x,t.y,t.z,0])}set jhat(t){this._matrix.setRow(1,[t.x,t.y,t.z,0])}set khat(t){this._matrix.setRow(2,[t.x,t.y,t.z,0])}set center(t){this._matrix.setRow(3,[t.x,t.y,t.z,1])}set matrix(t){this._matrix=t}get inverse(){return this._matrix.inverse()}setPosition(t){this.center=t}setNormal(t){this.khat=t}clone(){return new T(this._matrix.clone())}transform(t){return this._matrix=this._matrix.multiply(t),this}moveTo(t){return this.center=t,this}pullToPlane(t){return this.inverse.multiplyVector(t)}pushToWorld(t){return this.matrix.multiplyVector(t)}closestPoint(t){let e=this.pullToPlane(t),i=e.z;return e.z=0,[this.pushToWorld(e),i]}rotateVector(t,e){let i=this.pullToPlane(t);return i=o.newAxisRotation(this.normal,e).multiplyVector(i),this.pushToWorld(i)}}var P,L;!function(t){t[t.Invalid=0]="Invalid",t[t.Points=1]="Points",t[t.Lines=2]="Lines",t[t.Triangles=3]="Triangles",t[t.Quads=4]="Quads"}(P||(P={})),function(t){t[t.None=0]="None",t[t.Vertex=1]="Vertex",t[t.Face=2]="Face",t[t.MultiVertex=3]="MultiVertex"}(L||(L={}));class D{constructor(t,i,s,r,n){this._normKind=L.None,this.color=[1,1,1,1],this.linecolor=[1,1,1,1],this.mesh=e.newEmpty(t,r,3),this.norms=l.new(i),this.uvs=h.new(s),this.ambi=new Float32Array(t),this.texture=n,this.position=o.newIdentity()}static new(t,e,i,s,r){return new D(t,e,i,s,r)}static fromMesh(t){let e=new D(t.verts.count,0,0,t.links.count());return e.mesh=t,e}static fromData(t,e,i,s){let r=new D(t.length/3,e.length/3,i.length/2,s.length/3);return r.mesh.verts.slice().fillWith(t),r.mesh.links.fillWith(s),r.norms.slice().fillWith(e),r.uvs=h.fromData(i),r}static fromGraph(t){let e=t.toMesh(),i=D.fromMesh(e);return i.norms=l.fromList(t.allNorms()),i._normKind=L.Vertex,i}transform(t){for(let e=0;e<this.mesh.verts.count;e++){let i=this.mesh.verts.get(e),s=this.norms.get(e);this.mesh.verts.set(e,t.multiplyVector(i)),this.norms.set(e,t.multiplyVector(s))}}getAdjacentFaces(t){let e=[],i=this.mesh.links.count();for(let s=0;s<i;s++)this.mesh.links.getRow(s).includes(t)&&e.push(s);return e}getFaceVertices(t){return this.mesh.getLinkVerts(t)}getType(){return this.mesh.getType()}getNormalType(){return this._normKind}setTexture(t){this.texture=t}setUvs(t){t instanceof Float32Array?this.uvs=h.fromData(t):this.uvs=t}exportToObj(t){throw"todo"}calculateFaceNormals(){if(this.getType()!=P.Triangles)return console.error("can only calculate normals from triangular meshes"),void(this.norms=l.new(0));let t=this.mesh.calculateFaceNormals();this.norms=l.fromList(t),this._normKind=L.Face}calculateVertexNormals(){let t=this.mesh.calculateVertexNormals();this.norms=l.fromList(t),this._normKind=L.Vertex}calculateMultiVertexNormals(){this._normKind=L.MultiVertex,this.calculateFaceNormals();let t=this.mesh.verts.map(((e,i)=>{let s=this.getAdjacentFaces(i);t.set(i,this.norms.take(s).average())}));this.norms=t}}function F(t){let e=[],i=[],s=[],r=[];const n=/(\w*)(?: )*(.*)/,o=t.split("\n");for(let t=0;t<o.length;++t){const a=o[t].trim();if(""===a||a.startsWith("#"))continue;const h=n.exec(a);if(!h)continue;const[,l,u]=h,c=a.split(/\s+/).slice(1);switch(l){case"v":for(const t of c)e.push(parseFloat(t));break;case"vn":for(const t of c)i.push(parseFloat(t));break;case"vt":for(const t of c)s.push(parseFloat(t));break;case"f":for(const t of z(c))r.push(t);break;default:console.warn("unhandled keyword:",l);continue}}return D.fromData(e,i,s,r)}function S(t){let e=[],i=t.split("/");if(1==i.length)e.push(parseInt(i[0])-1);else{if(3!=i.length)throw"invalid face found when processing";e.push(parseInt(i[0])-1)}return e}function z(t){let e=[];if(4==t.length){let i=S(t[0]),s=S(t[1]),r=S(t[2]),n=S(t[3]);e.push(...i,...s,...r,...i,...r,...n)}else if(3==t.length){let i=S(t[0]),s=S(t[1]),r=S(t[2]);e.push(...i,...s,...r)}return e}class N{constructor(){this.verts=[],this.edges=[]}static new(){return new N}static fromMesh(t){let e=N.new(),i=t.calculateVertexNormals();t.verts.forEach(((t,s)=>{e.addVert(t,i[s])}));let s=t.getType();if(s==P.Invalid||s==P.Points)return e;new v;let r=t.links._width;return t.links.forEachRow(((t,i)=>{for(let i=0;i<r;i++){let s=(i+1)%r,n=t[i],o=t[s];-1!=n&&-1!=o&&e.addEdgeIfNew(n,o)}})),e}clone(){throw new Error("not yet implemented...")}transform(t){for(let e=0;e<this.verts.length;e++){let i=this.verts[e];i.pos=t.multiplyVector(i.pos)}}print(){console.log("graph"),console.log("--------"),console.log(`${this.verts.length} verts: `);for(let t=0;t<this.verts.length;t++){let e=this.verts[t];console.log(`v(${t}) | edge: ${e.edge}, data: ${e.pos.toString()} normal: ${e.normal.toString()}`)}console.log("--------"),console.log(`${this.edges.length} edges:  `);for(let t=0;t<this.edges.length;t++){let e=this.edges[t];console.log(`e(${t}) | vert: ${e.vert}, twin: ${e.twin}, next: ${e.next}, dead ${e.dead}`)}console.log("--------")}toMesh(){return e.fromGraph(this)}toLines(){return e.newLines(this.allVertPositions(),this.allUniqueEdgeVerts())}toRenderable(){return D.fromGraph(this)}allNorms(){let t=[];return this.verts.forEach((e=>{t.push(e.normal)})),t}allVertPositions(){let t=[];return this.verts.forEach((e=>{t.push(e.pos)})),t}allUniqueEdges(){let t=[],e=this.edges.length/2;for(let i=0;i<e;i++){let e=2*i,s=2*i+1,r=this.getEdge(e),n=this.getEdge(s);r.dead||n.dead||t.push(e)}return t}allUniqueEdgeVerts(){let t=[],e=this.edges.length/2;for(let i=0;i<e;i++){let e=2*i,s=2*i+1,r=this.getEdge(e),n=this.getEdge(s);r.dead||n.dead||t.push(r.vert,n.vert)}return t}allEdgeVerts(){let t=[];return this.edges.forEach(((e,i)=>{if(e.dead)return;let s=e.vert,r=this.getEdge(e.twin).vert;s<r&&(t.push(s),t.push(r))})),t}allVertLoops(){throw"TODO"}allVertLoopsAsInts(){let t=[],e=new Set;this.edges.forEach(((t,i)=>{t.dead||e.add(i)}));let i=0;const s=this.edges.length;for(;e.size>0;){let r=[],n=e.entries().next().value[0],o=n;do{if(i>s)throw"topology is corrupt!";i+=1;let t=this.getEdge(n);e.delete(n),r.push(t.vert),n=t.next}while(n!=o);t.push(r)}return t}getLoop(t){let e=[],i=0;const s=this.edges.length;let r=t;do{if(i>s)throw"topology is corrupt!";i+=1;let r=this.getEdge(t);e.push(t),t=r.next}while(t!=r);return e}getVertexPos(t){if(t<0||t>=this.verts.length)throw"out of range";return this.verts[t].pos}getVertexNormal(t){if(t<0||t>=this.verts.length)throw"out of range";return this.verts[t].normal}getVertexCount(){return this.verts.length}getHalfEdgeCount(){return this.edges.length}changeVertex(t,e,i){let s=this.verts[t];s.pos=e,s.normal=i}getVert(t){if(t<0||t>=this.verts.length)throw"out of range";return this.verts[t]}getEdge(t){return(t<0||t>=this.edges.length)&&console.error("out of range"),this.edges[t]}getEdgeIndexBetween(t,e){let i=this.getEdgeBetween(t,e);if(i)return this.getEdgeIndex(i)}getEdgeBetween(t,e){let i=this.getVertEdgeFan(t);for(let t=0;t<i.length;t++)if(this.getEdge(i[t].twin).vert==e)return i[t]}getVertEdgeFan(t){let e=[],i=this.verts[t].edge,s=i;if(-1==i)return e;let r=0;for(;;){if(r>this.verts.length)throw this.print(),console.log("fan: ",e),"nope";r+=1;let t=this.getEdge(i),n=this.getEdgeTwin(i);if(e.push(t),i=n.next,i==s)break}return e}getLoopsAdjacentToEdge(t){let e=[];return e.push(this.getLoop(t)),e.push(this.getLoop(this.getEdge(t).twin)),e}getVertNeighbors(t){let e=[];return this.getVertEdgeFan(t).forEach((t=>{e.push(this.getEdge(t.twin).vert)})),e}getEdgeIndex(t){return this.getEdge(t.twin).twin}getEdgeTwin(t){return this.edges[this.edges[t].twin]}hasEdge(t,e){return this.getVertNeighbors(t).includes(e)}addVert(t,e){return this.verts.push({pos:t,edge:-1,normal:e,dead:!1}),this.verts.length-1}removeVert(t){throw"TODO FIGURE OUT NULL & REMOVAL"}addEdgeIfNew(t,e){return!this.hasEdge(t,e)&&(this.addEdge(t,e),!0)}addEdge(t,e){let i=this.edges.length,s=i+1;this.edges.push({next:-1,twin:s,vert:t,dead:!1}),this.edges.push({next:-1,twin:i,vert:e,dead:!1}),this.addEdgeToDisk(t,i),this.addEdgeToDisk(e,s)}deleteEdgeByIndex(t){this.deleteEdge(this.getEdge(t))}deleteEdge(t){let e=this.getEdge(t.twin);t.dead=!0,e.dead=!0,this.deleteEdgeFromDisk(t),this.deleteEdgeFromDisk(e)}getDiskPositions(t){let e=this.getEdge(t),i=this.getVert(e.vert),s=this.getEdgeTwin(t),r=this.verts[s.vert],n=i.pos.subbed(r.pos),o=[];o.push(n);let a=this.getVertEdgeFan(e.vert),h=[];for(let e=0;e<a.length;e++){let i=a[e];this.getEdgeIndex(i)==t||h.push(i)}if(0==h.length)return[t,t];if(1==h.length){let t=h[0];return[this.getEdgeIndex(t),this.getEdgeIndex(t)]}for(let t=0;t<h.length;t++){let e=h[t],s=this.getEdge(e.twin),r=this.verts[s.vert],n=i.pos.subbed(r.pos);o.push(n)}let l=T.fromPN(i.pos,i.normal),u=l.ihat,d=l.jhat,f=c.calculateWheelOrder(o,u,d),m=-1,g=-1;for(let t=0;t<f.length;t++){let e=(t+1)%f.length,i=(t+2)%f.length;if(0==f[e]){m=f[t],g=f[i];break}}let w=h[g-1],p=h[m-1];return[this.getEdgeIndex(w),this.getEdgeIndex(p)]}addEdgeToDisk(t,e){let i=this.getVert(t),s=this.getEdgeTwin(e);if(-1==i.edge)i.edge=e,s.next=e;else{let[t,i]=this.getDiskPositions(e),[r,n]=[this.getEdge(t),this.getEdge(i)];this.getEdge(r.twin).next=e,s.next=this.getEdgeIndex(n)}}deleteEdgeFromDisk(t){let e=this.getEdgeIndex(t),i=this.getVert(t.vert),[s,r]=this.getDiskPositions(e);if(s==e)return void(i.edge=-1);let[n,o]=[this.getEdge(s),this.getEdge(r)];this.getEdge(n.twin).next=r,i.edge==e&&(i.edge=r)}splitEdge(t,e,i){let s=this.getEdgeBetween(t,e);if(!s)throw new Error(`No Edge found between ${t} and ${e}`);this.getEdge(s.twin);let r=this.getVert(t),n=this.getVert(e),o=c.fromLerp(r.pos,n.pos,i),a=c.fromLerp(r.normal,n.normal,i),h=this.addVert(o,a);return this.getVert(h),this.deleteEdge(s),this.addEdge(t,h),this.addEdge(h,e),h}subdivide(){let t=this.allEdgeVerts(),e=this.allVertLoopsAsInts(),i=new v,s=t.length/2,r=new Array(s);for(let e=0;e<s;e++){let s=t[2*e],n=t[2*e+1],o=this.splitEdge(s,n,.5);r[e]=o,i.set([s,n],o),i.set([n,s],o)}for(let t=0;t<e.length;t++){let s=e[t],r=new Array(s.length);for(let t=0;t<s.length;t++){let e=(t+1)%s.length,n=s[t],o=s[e];r[t]=i.get([n,o])}for(let t=0;t<s.length;t++){let e=(t+1)%s.length;this.addEdge(r[t],r[e])}}}subdivideQuad(){let t=this.allEdgeVerts(),e=this.allVertLoopsAsInts(),i=new v,s=t.length/2;for(let e=0;e<s;e++){let s=t[2*e],r=t[2*e+1],n=this.splitEdge(s,r,.5);i.set([s,r],n),i.set([r,s],n)}for(let t=0;t<e.length;t++){let s=e[t],r=c.zero();for(let t=0;t<s.length;t++)r.add(this.getVertexPos(s[t]));r.scale(1/s.length);let n=k(s.map((t=>this.getVertexPos(t)))),o=this.addVert(r,n);for(let t=0;t<s.length;t++){let e=(t+1)%s.length,r=s[t],n=s[e],a=i.get([r,n]);this.addEdge(o,a)}}}forEveryEdgeVerts(t){let e=this.allUniqueEdgeVerts(),i=e.length/2;for(let s=0;s<i;s++){let i=this.getVert(e[2*s]),r=this.getVert(e[2*s+1]);t(i.pos,r.pos)}}}function k(t){let e=t.length;if(e<3)throw"cannot get face planar with 2 or less edges";c.zero();let i=t[1].subbed(t[0]),s=t[2].subbed(t[1]);for(let n=1;n<e;n++){if(Math.abs(i.dot(s))>r.TOLERANCE)return i.cross(s);{let i=(n+1)%e;s=t[(n+2)%e].subbed(t[i])}}throw"get planar face failed..."}class B extends D{constructor(t,e,i,s,r){super(t,e,i,s,r),this.lastTouched=0,this.neighborMap=new _(this.mesh.links.count(),3)}static copyFromRenderable(t){let e=new B(t.mesh.verts.count,t.norms.count,t.uvs.count,t.mesh.links.count());return e.mesh.verts=t.mesh.verts.clone(),e.norms=t.norms.clone(),e.uvs=t.uvs.clone(),e.mesh.links=t.mesh.links.clone(),e.setNeighborMap(),e}setNeighborMap(){let t=new v,e=new v;this.mesh.links.forEachRow(((i,s)=>{[[i[0],i[1]],[i[1],i[2]],[i[2],i[0]]].forEach((i=>{let r=i[0]>i[1],n=new Int32Array([Math.min(...i),Math.max(...i)]);if(t.has(n)){let i=t.get(n),o=i[0],a=i[1];i[2]=s,t.set(n,i),this.setNb(s,n,a),this.setNb(a,n,s);let h=[a,s];h.sort(),r!=o?e.set(h,!1):e.set(h,!0)}else t.set(n,[r,s,-1])}))})),console.log("number of 'wrong' face neighbours: ",0)}walkUV(t){let e=this.lastTouched,i=this.mesh.links.count();for(let s=0;s<i;s++){if(-1==e)return-1;for(let i=0;i<3;i++){let s=(i+1)%3,r=this.mesh.links.getRow(e),n=[r[i],r[s]],o=this.uvs.get(n[0]),a=this.uvs.get(n[1]);if(t.sign(o,a)<0){if(e=this.getNb(e,n),-1==e)return-1;this.lastTouched=e;break}if(2==i)return e}}return-1}closestFaces(t){let e=this.mesh.verts.closestId(t),i=[];return this.mesh.links.forEachRow(((t,s)=>{t.includes(e)&&i.push(s)})),i}elevate(t){let e=this.walkUV(t);if(-1==e)return console.warn("got a point not on triangle..."),new c(0,0,0);let i=this.getTriangle3(e),s=this.getTriangle2(e).toBarycentric(t);return i.fromBarycentric(s)}closestFace(t){let e=this.closestFaces(t),i=l.new(e.length);return e.forEach(((e,s)=>{let r=this.getTriangle3(e).closestPoint(t);i.set(s,r)})),e[i.closestId(t)]}flatten(t,e){let i=this.getTriangle3(e),s=this.getTriangle2(e),r=i.toBarycentric(t);return s.fromBarycentric(r)}flattenClosestPoint(t){let e=this.closestFace(t);return this.flatten(t,e)}closestPoint(t){let e=this.closestFace(t),i=this.getTriangle3(e),s=i.toBarycentric(t);return i.fromBarycentric(s)}getTriangle2(t){let e=this.getFacePoints(t,!0);return new Y(e[0],e[1],e[2])}getTriangle3(t){let e=this.getFacePoints(t,!1);return new O(e[0],e[1],e[2])}setNb(t,e,i){for(let s=0;s<3;s++)if(!e.includes(this.mesh.links.get(t,s)))return void this.neighborMap.set(t,s,i);throw console.log(this.mesh.links.getRow(t)),console.log(e),"these are not actually neighbors!"}getNb(t,e){for(let i=0;i<3;i++)if(!e.includes(this.mesh.links.get(t,i)))return this.neighborMap.get(t,i);throw console.log(this.mesh.links.getRow(t)),console.log(e),"common edge does not match triangle index!"}getFacePoints(t,e){let i=this.mesh.links.getRow(t);return e?[this.uvs.get(i[0]),this.uvs.get(i[1]),this.uvs.get(i[2])]:[this.mesh.verts.get(i[0]),this.mesh.verts.get(i[1]),this.mesh.verts.get(i[2])]}}class C{constructor(t,e){this.from=t,this.to=e,this.vector=e.subbed(this.from),this.normal=this.vector.normalized(),this.bounds=new m(0,this.vector.length()),this.length=this.vector.length()}at(t,e=!0){return e&&(t=this.bounds.comform(t)),f.fromLerp(this.from,this.to,t/this.length)}atNormal(t,e=!0){return e&&(t=new m(0,1).comform(t)),f.fromLerp(this.from,this.to,t)}closestPoint(t,e=!0){if(0===this.vector.length())return;let i=t.subbed(this.from).dot(this.vector);return this.at(i,e)}}class I extends a{constructor(t,e,i=m.new(0,1)){super(),this.verts=t,this.degree=e,this.domain=i}toPolyline(t){let e=t+1,i=l.new(e);for(let s=0;s<e;s++){let e=s/t;i.set(s,this.pointAt(this.domain.elevate(e)))}return U.new(i)}buffer(t){return b.fromPolyline(this.toPolyline(t))}}class U extends I{constructor(t){super(t,1),this.bufferLengths()}static fromList(t){return this.new(l.fromList(t))}static new(t){return new U(t)}pointAt(t){let e=t*(this.verts.count-1),i=Math.floor(e),s=Math.ceil(e);return c.fromLerp(this.verts.get(i),this.verts.get(s),e-i)}lengthAt(e){let i=this.getLazyLengths();return t.sample(i,e)}tAtLength(e){let i=this.getLazyLengths(),[s,r]=t.between(i,e),[n,o]=[i[s],i[r]],a=t.fraction(e,n,o);return t.lerp(i[s],i[r],a)}length(){return this.getLazyLengths()[this.verts.count-1]}getLazyLengths(){return this._lengths||this.bufferLengths(),this._lengths}bufferLengths(){let t=this.verts.count,e=Array(t),i=0;e[0]=i;for(let s=0;s<t-1;s++)i+=this.verts.get(s).disTo(this.verts.get(s+1)),e[s+1]=i;this._lengths=e}buffer(){return b.fromPolyline(this)}clone(){return U.new(this.verts.clone())}transform(t){return this._lengths=void 0,this.verts.transform(t),this}transformed(t){return this._lengths=void 0,U.new(this.verts.transformed(t))}}class V{constructor(t,e){this.plane=t,this.domain=e}static new(t,e){return new V(t,e)}getCorners(){return this.domain.corners().map((t=>this.plane.pushToWorld(t.to3D())))}}class Y{constructor(t,e,i){this.a=t,this.b=e,this.c=i}points(){return h.fromList([this.a,this.b,this.c])}toBarycentric(t){let e=this.b.subbed(this.a),i=this.c.subbed(this.a),s=t.subbed(this.a),r=e.dot(e),n=e.dot(i),o=i.dot(i),a=s.dot(e),h=s.dot(i),l=r*o-n*n,u=(o*a-n*h)/l,d=(r*h-n*a)/l;return new c(1-u-d,u,d)}fromBarycentric(t){let e=this.a.scaled(t.x),i=this.b.scaled(t.y),s=this.c.scaled(t.z);return e.add(i).add(s)}closestPoint(t){let e=t.sign(this.a,this.b),i=t.sign(this.b,this.c),s=t.sign(this.c,this.a);if(e<0&&i<0&&s<0||e>0&&i>0&&s>0)return console.log("fully inside!"),t;{let r=Math.abs(e),n=Math.abs(i),o=Math.abs(s);return r<n&&r<o?new C(this.a,this.b).closestPoint(t):n<o?new C(this.b,this.c).closestPoint(t):new C(this.c,this.a).closestPoint(t)}}}class O{constructor(t,e,i){this.a=t,this.b=e,this.c=i}points(){return[this.a,this.b,this.c]}getPlane(){return T.from3pt(this.a,this.b,this.c)}to2D(t=T.WorldXY()){return new Y(t.pullToPlane(this.a).to2D(),t.pullToPlane(this.b).to2D(),t.pullToPlane(this.c).to2D())}closestPoint(t){let e=this.getPlane(),[i,s]=e.closestPoint(t);return e.pullToPlane(i),this.to2D(e),t}toBarycentric(t){let e=this.b.subbed(this.a),i=this.c.subbed(this.a),s=t.subbed(this.a),r=e.dot(e),n=e.dot(i),o=i.dot(i),a=s.dot(e),h=s.dot(i),l=r*o-n*n,u=(o*a-n*h)/l,d=(r*h-n*a)/l;return new c(1-u-d,u,d)}fromBarycentric(t){let e=this.a.clone().scale(t.x),i=this.b.clone().scale(t.y),s=this.c.clone().scale(t.z);return e.added(i).add(s)}}class j{static bernstein(t,e,i){return this.getBicoef(i,e)*Math.pow(t,e)*Math.pow(1-t,i-e)}static coxdeboor(t,e,i,s){if(0==i)return t>=s[e]&&t<s[e+1]?1:0;let r=s[e+i]-s[e],n=s[e+i+1]-s[e+1],o=(t-s[e])/r,a=(s[e+i+1]-t)/n;return o*this.coxdeboor(t,e,i-1,s)+a*this.coxdeboor(t,e+1,i-1,s)}static coxdeboorTriangle(e,i,s,r){let n=r.length,o=new Float32Array(t.stack(n)),a=u.iterateTriangle,h=n-1;for(let t=0;t<=h;t++){let s=a(h,t);(r[i]<=e||e<r[i+1])&&(o[s]=1),o[s]=0}for(let t=n-2;t>-1;t-=1)for(let n=0;n<=t;n++){let h=a(t,n),l=o[a(t+1,n)],u=o[a(t+1,n+1)],c=(e-r[i])/(r[i+s]-r[i]),d=(r[i+s+1]-e)/(r[i+s+1]-r[i+1]);o[h]=c*l+d*u}return o}static getBicoef(t,e){return this._pascal[t][e]}static calcBicoef(e,i){let s=t.factorial;return s(e)/(s(i)*s(e-i))}static calcPascal(t){let e=Array(t);for(let i=0;i<t;i++){e[i]=Array(i+1);for(let t=0;t<i+1;t++)e[i][t]=this.calcBicoef(i,t)}return e}static decastejau(e,i){let s=e.count,r=l.new(t.stack(s)),n=u.iterateTriangle,o=s-1,a=0;for(let t=0;t<=o;t++){let i=n(o,t);r.set(i,e.get(a)),a++}for(let t=s-2;t>-1;t-=1)for(let e=0;e<=t;e++){let s=n(t,e),o=r.get(n(t+1,e)),a=r.get(n(t+1,e+1)).scale(i).add(o.scale(1-i));r.set(s,a)}return r}static decastejauExtrapolateEnd(e,i){let s=e.count,r=l.new(t.stack(s)),n=u.iterateTriangle,o=0;for(let t=s-1;t>-1;t-=1){let i=n(t,0);r.set(i,e.get(o)),o++}for(let t=1;t<s;t++)for(let e=1;e<=t;e++){let s=n(t-1,e-1),o=n(t,e-1),a=n(t,e),h=r.get(o).lerp(r.get(s),1+i);r.set(a,h)}return r}static decastejauExtrapolateStart(e,i){let s=e.count,r=l.new(t.stack(s)),n=u.iterateTriangle,o=s-1,a=0;for(let t=0;t<=o;t++){let i=n(o,t);r.set(i,e.get(a)),a++}for(let t=s-2;t>-1;t-=1)for(let e=0;e<=t;e++){let s=n(t,e),o=r.get(n(t+1,e)),a=r.get(n(t+1,e+1)).scale(i).add(o.scale(1-i));r.set(s,a)}return r}}j.MAX_DEGREE=15,j._pascal=j.calcPascal(j.MAX_DEGREE);class W extends I{constructor(t,e){super(t,e)}static fromList(t){return this.new(l.fromList(t))}static new(t){return new W(t,t.count-1)}static equalizeDegrees(t){let e=0;for(let i of t)i.degree>e&&(e=i.degree);for(let i=0;i<t.length;i++){let s=0;for(;t[i].degree<e&&s<100;)t[i]=t[i].increaseDegree(),s++}return t}hodograph(){let t=l.new(this.verts.count-1);for(let e=0;e<this.verts.count-1;e++)t.set(e,this.verts.get(e+1).subbed(this.verts.get(e)));return W.new(t)}increaseDegree(){let t=this.degree,e=l.new(t+2);e.set(0,this.verts.get(0)),e.set(e.count-1,this.verts.get(this.verts.count-1));for(let i=1;i<t+1;i++){let s=this.verts.get(i-1),r=this.verts.get(i),n=i/(t+1),o=1-n,a=s.scale(n).add(r.scale(o));e.set(i,a)}return W.new(e)}splitAt(t){let e=this.degree+1,i=j.decastejau(this.verts,t),s=u.getTriangleLeft(i,e),r=u.getTriangleRight(i,e);return[W.new(s),W.new(r)]}extend(t){let e=j.decastejauExtrapolateEnd(this.verts,t),i=this.verts.count,s=u.getTriangleBase(e,i);this.verts=s}getExtention(t){let e=j.decastejauExtrapolateEnd(this.verts,t),i=this.verts.count,s=u.getTriangleRight(e,i);return W.new(s)}pointAt(t){let e=c.zero();for(let i=0;i<this.degree+1;i++)e.add(this.verts.get(i).scaled(j.bernstein(t,i,this.degree)));return e}tangentAt(t){return this.hodograph().pointAt(t).normalize()}normalAt(t,e=c.unitZ()){return this.tangentAt(t).cross(e)}ApproxClosestPoint(t,e=5,i=r.TOLERANCE){let s=e=>t.disToSquared(this.pointAt(e)),n=e*this.verts.count,o=1/0,a=-1;for(let t=1;t<n+1;t++){let e=s(t/n);e<o&&(o=e,a=t)}let h=Math.max((a-1)/n,0),l=Math.min((a+1)/n,1),c=m.new(h,l);return u.lowestScore(c,s,i)}uglyClosestPoint(t,e=4){let i=[],s=[],r=t=>{i.push(this.pointAt(t)),s.push(t)};r(this.domain.t0),r(this.domain.t1);let n=1/0,o=-1;for(let e=0;e<i.length;e++){let s=t.disToSquared(i[e]);s<n&&(n=s,o=e)}return[i[o],s[o]]}pointAtApproxLength(t){this.toPolyline(100).tAtLength(t)}getLazyApprox(){return this._approx||this.bufferApprox(),this._approx}bufferApprox(){this._approx=this.toPolyline(100)}clone(){return W.new(this.verts.clone())}transform(t){return this._approx=void 0,this.verts.transform(t),this}transformed(t){return this._approx=void 0,W.new(this.verts.transformed(t))}}class X extends a{}class q extends X{buffer(t,i){return e.fromBiSurface(this,t,i)}}class K{constructor(t,e,i,s){this.a=t,this.b=e,this.c=i,this.d=s}static new(t,e,i,s){return new K(t,e,i,s)}static randomSeed(){return 393847477636*Math.random()}static fromSeed(t){for(var e=3735928559^t,i=K.new(2654435769,608135816,3084996962,e),s=0;s<15;s++)i.get();return i}static fromRandom(){return this.fromSeed(103948857*Math.random())}static fromHash(t){var e=function(t){for(var e=0,i=1779033703^t.length;e<t.length;e++)i=(i=Math.imul(i^t.charCodeAt(e),3432918353))<<13|i>>>19;return function(){return i=Math.imul(i^i>>>16,2246822507),i=Math.imul(i^i>>>13,3266489909),(i^=i>>>16)>>>0}}(t);return this.new(e(),e(),e(),e())}get(){this.a>>>=0,this.b>>>=0,this.c>>>=0,this.d>>>=0;let t=this.a+this.b|0;return this.a=this.b^this.b>>>9,this.b=this.c+(this.c<<3)|0,this.c=this.c<<21|this.c>>>11,this.d=this.d+1|0,t=t+this.d|0,this.c=this.c+t|0,(t>>>0)/4294967296}}class ${constructor(t,e){this.oldTime=t,this.newTime=e}static new(){let t=new $(0,0);return t.time(),t}time(){this.newTime=this.getTime();let t=this.newTime-this.oldTime;return this.oldTime=this.newTime,t}log(t){console.log(`${t} took: ${this.time()} ms`)}getTime(){return(new Date).getTime()}}class G extends q{constructor(t,e,i){super(),this.verts=t,this.degreeU=e,this.degreeV=i}static new(t,e,i){if(t.count==(e+1)*(i+1))return new G(t,e,i);console.warn(`BiSurface Not Created. ${t.count} vertices \n                does not match ${e} degreeU times ${i} degreeV surface...`)}static fromFourEdge(t,e,i,s){}static fromLoft(t){let e=(t=W.equalizeDegrees(t))[0].degree,i=t.length-1,s=e+1*t.length,r=l.new(s),n=0;for(let e=0;e<t.length;e++)for(let i=0;i<t[e].verts.count;i++)r.set(n,t[e].verts.get(i)),n++;return G.new(r,i,e)}pointAt(t,e){let i=c.zero();for(let s=0;s<this.degreeU+1;s++)for(let r=0;r<this.degreeV+1;r++){let n=j.bernstein(t,s,this.degreeU)*j.bernstein(e,r,this.degreeV),o=s*(this.degreeV+1)+r;i.add(this.verts.get(o).scaled(n))}return i}pointAtUV(t){return this.pointAt(t.x,t.y)}approxClosestPoint(t,e=2,i=r.TOLERANCE){let s=(e,i)=>t.disToSquared(this.pointAt(e,i)),n=e*(this.degreeU+1),o=e*(this.degreeV+1),a=1/0,h=-1,l=-1;for(let t=1;t<n+1;t++){let e=t/n;for(let i=1;i<n+1;i++){let r=s(e,i/o);r<a&&(a=r,h=t,l=i)}}let c=g.fromBounds(Math.max((h-1)/n,0),Math.min((h+1)/n,1),Math.max((l-1)/o,0),Math.min((l+1)/o,1));return u.lowestScoreSquared(c,s,i)}clone(){return G.new(this.verts.clone(),this.degreeU,this.degreeV)}transform(t){return this._approx=void 0,this.verts.transform(t),this}transformed(t){return this._approx=void 0,G.new(this.verts.transformed(t),this.degreeU,this.degreeV)}}!function(t=1e3){let e=$.new(),i=K.fromSeed(1234),s=g.fromRadius(-11).offset([-22,22,0,0]).spawn(3,3).to3D().forEach((t=>t.add(c.fromRandomUnit(i).scale(5)).add(c.unitZ().scale(5)))),r=G.new(s,2,2),n=g.fromRadii(11,11);e.log("creation");for(let e=0;e<t;e++){let t=n.elevate(f.fromRandom(i)).to3D();r.approxClosestPoint(t)}e.log(`created ${t} closest points`)}();class H{constructor(t,e,i=4){this.width=t,this.height=e,this.pixelSize=i,this.data=new Uint8ClampedArray(this.width*this.height*this.pixelSize),this.data.fill(0)}static fromImageData(t){let e=new H(t.width,t.height);return e.setData(t.data),e}toImageData(){if(4!=this.pixelSize)throw"pixelsize must be 4 for toImageData to work";return new ImageData(this.data,this.width,this.height)}setData(t){if(t.length!=this.height*this.width*this.pixelSize)throw"data.length does not match width * height ";this.data=t}clone(){let t=new H(this.width,this.height,this.pixelSize);return t.setData(this.data),t}fill(t){for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++)this.set(i,e,t);return this}fillEvery(t){for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++)this.set(i,e,t());return this}includes(t,e){return t<this.width&&t>=0&&e<this.height&&e>=0}set(t,e,i){this.data[4*(e*this.width+t)]=i[0],this.data[4*(e*this.width+t)+1]=i[1],this.data[4*(e*this.width+t)+2]=i[2],this.data[4*(e*this.width+t)+3]=i[3]}get(t,e){return[this.data[4*(e*this.width+t)],this.data[4*(e*this.width+t)+1],this.data[4*(e*this.width+t)+2],this.data[4*(e*this.width+t)+3]]}flipHor(){let t=new H(this.width,this.height,this.pixelSize);for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){let s=this.width-1-i;t.set(i,e,this.get(s,e))}return t}flipVer(){let t=new H(this.width,this.height,this.pixelSize);for(let e=0;e<this.height;e++){let i=this.height-1-e;for(let s=0;s<this.width;s++)t.set(s,e,this.get(s,i))}return t}applyKernel(t){let e=t.count()/2-.5,i=new H(this.width-2*e,this.height-2*e,this.pixelSize);for(let s=e;s<this.width-e;s++)for(let r=e;r<this.height-e;r++){let n=this.getWithKernel(s,r,t,e);i.set(s-e,r-e,n)}return i}getMinMax(){let t=1/0,e=0;for(let i=0;i<this.data.length;i++)this.data[i]<t?t=this.data[i]:this.data[i]>e&&(e=this.data[i]);return[t,e]}applyThreshold(t,e){return this.apply(((i,s)=>{let r=this.get(i,s);return r[0]<t?[0,0,0,0]:r[0]>e?[255,255,255,255]:r}))}apply(t){let e=new H(this.width,this.height,this.pixelSize);for(let i=0;i<this.height;i++)for(let s=0;s<this.width;s++)e.set(s,i,t(s,i));return e}applyNMS(){let t=new H(this.width-2,this.height-2,this.pixelSize);for(let t=1;t<this.width-1;t++)for(let t=1;t<this.height-1;t++);return t}getWithKernel(t,e,i,s){let r=[0,0,0,255],[n,o]=i.getDimensions();for(let a=0;a<n;a++)for(let n=0;n<o;n++){let o=i.get(a,n),h=this.get(t+a-s,e+n-s);for(let t=0;t<3;t++)r[t]+=h[t]*o}return r}setAplha(t){for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){let s=this.get(i,e);this.set(i,e,[s[0],s[1],s[2],t])}return this}scale(t,e){return this.resize(Math.round(this.width*t),Math.round(this.height*e))}resize(t,e){const i=new H(t,e,this.pixelSize),s=this,r=1/i.width*s.width,n=1/i.height*s.height;for(let t=0;t<i.height;t++)for(let e=0;e<i.width;e++){let o=s.get(Math.round(e*r),Math.round(t*n));i.set(e,t,o)}return i}buffer(t,e){const i=new H(t,e,this.pixelSize),s=this;for(let r=0;r<e;r++)for(let e=0;e<t;e++){let t=s.includes(e,r)?s.get(e,r):[0,0,0,255];i.set(e,r,t)}return i}trimWithDomain(t){const e=Math.round(t.x.t0),i=Math.round(t.x.t1),s=Math.round(t.y.t0),r=Math.round(t.y.t1);return this.trim(e,s,i,r)}trim(t,e,i,s){const r=i-t,n=s-e,o=new H(r,n,this.pixelSize);for(let i=0;i<n;i++)for(let s=0;s<r;s++){let r=this.get(s+t,i+e);o.set(s,i,r)}return o}toGreyscale(){if(4!=this.pixelSize)throw"please, only use this when pixelsize is 4";let t=new H(this.width,this.height,4);for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){let s=this.get(i,e),r=(s[0]+s[1]+s[2])/3;t.set(i,e,[r,r,r,255])}return t}toRGBA(){return this}}class Z{static generateGaussianKernel(t,e){var i,s,r,o,a,h,l,u,c,d,f,m,g,w,p,x;for(a=t,o=new n(e,e),h=0,s=c=0,g=e-1;0<=g?c<=g:c>=g;s=0<=g?++c:--c)for(l=-(e-1)/2+s,r=d=0,w=e-1;0<=w?d<=w:d>=w;r=0<=w?++d:--d)u=-(e-1)/2+r,i=1/(2*Math.PI*a*a)*Math.pow(2.718,-(l*l+u*u)/(2*a*a)),o.set(s,r,i),h+=i;for(s=f=0,p=e-1;0<=p?f<=p:f>=p;s=0<=p?++f:--f)for(r=m=0,x=e-1;0<=x?m<=x:m>=x;r=0<=x?++m:--m)o.set(s,r,o.get(s,r)/h);return o}}Z.SmoothKernel=new n(3,3,[1,1,1,1,1,1,1,1,1]).forEachValue((t=>1*t/9)),Z.SmoothKernel5=new n(5,5,[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]).forEachValue((t=>1*t/25)),Z.Gauss5=new n(5,5,[2,4,5,4,2,4,9,12,9,4,5,12,15,12,5,4,9,12,9,4,2,4,5,4,2]).forEachValue((t=>1*t/159)),Z.TestKernel=new n(3,3,[1,0,-1,0,0,0,-1,0,1]),Z.SobelLeft=new n(3,3,[1,2,1,0,0,0,-1,-2,-1]),Z.SobelRight=new n(3,3,[-1,-2,-1,0,0,0,1,2,1]),Z.SobelUp=new n(3,3,[1,0,-1,2,0,-2,1,0,-1]),Z.SobelDown=new n(3,3,[-1,0,1,-2,0,2,-1,0,1]);class J{constructor(t,e=1,i=!1,s=!0){this.angleAlpha=0,this.angleBeta=0,this.mousePos=f.zero(),this.fov=20*Math.PI/100,this.zFar=1e4,this.zNear=.1,this.speed=1,this.worldPlane=T.WorldXY(),this.canMove=i,this.canControl=s,this.pos=new c(0,0,0),this.z_offset=-e,this.offset=new c(0,0,-e),this.updateMatrices(t)}new(t,e=1,i=!1){return new J(t,e,i)}update(t){this.updateControls(t),this.updateMatrices(t.canvas),this.updateClick(t),t.IsKeyPressed("p")&&(console.log(`camera state: [${this.pos.x.toPrecision(5)}, ${this.pos.y.toPrecision(5)}, ${this.pos.z.toPrecision(5)}, ${this.z_offset}, ${this.angleAlpha},${this.angleBeta}]`),console.log("speed is now: "+this.speed))}getState(){return[this.pos.x,this.pos.y,this.pos.z,this.z_offset,this.angleAlpha,this.angleBeta]}setState(t){this.pos.x=t[0],this.pos.y=t[1],this.pos.z=t[2],this.z_offset=t[3],this.angleAlpha=t[4],this.angleBeta=t[5]}set(t,e,i){this.z_offset=t,this.angleAlpha=e,this.angleBeta=i}updateMatrices(t){this.worldMatrix=this.getWorldMatrix(),this.projectMatrix=this.getProjectionMatrix(t),this.totalMatrix=this.worldMatrix.multiplied(this.projectMatrix)}lookat(t,e){o.newLookAt(t,e,this.worldPlane.khat)}updateClick(t){}updateControls(e){if(!this.canControl)return;let i=1.2*e.scrollValue;this.offset.z=Math.min(-.001,this.z_offset-i),e.IsKeyPressed("Shift")&&(this.speed*=2),e.IsKeyPressed("Control")&&(this.speed=Math.max(.5*this.speed,.1));let s=this.mousePos.clone();this.mousePos=e.mousePos.clone();let r=s.clone().sub(this.mousePos);function n(t){return o.newZRotation(t).multiplyVector(c.unitY())}function a(t){return o.newZRotation(t).multiplyVector(c.unitX())}this.getMouseWorldRay(e.canvas.width,e.canvas.height),e.mouseRightDown&&(this.angleAlpha=t.clamp(this.angleAlpha+.01*r.y,0,Math.PI),this.angleBeta+=-.01*r.x),this.canMove&&(e.IsKeyDown("s")&&this.pos.add(n(-this.angleBeta).scale(.01*this.speed)),e.IsKeyDown("w")&&this.pos.add(n(-this.angleBeta).scale(-.01*this.speed)),e.IsKeyDown("a")&&this.pos.add(a(-this.angleBeta).scale(.01*this.speed)),e.IsKeyDown("d")&&this.pos.add(a(-this.angleBeta).scale(-.01*this.speed)),e.IsKeyDown("q")&&(this.pos.z+=.01*this.speed),e.IsKeyDown("e")&&(this.pos.z-=.01*this.speed))}getCameraPoint(){return this.worldMatrix.inverse().multiplyVector(new c(0,0,0))}getMouseWorldRay(t,e,i=!0){let s=this.mousePos,r=t/e,n=(s.x/t-.5)*r,o=s.y/e-.5,a=.5/Math.tan(this.fov/2),h=this.worldMatrix.inverse(),l=h.multiplyVector(new c(0,0,0)),u=h.multiplyVector(new c(1,0,0)),d=h.multiplyVector(new c(0,1,0)),f=h.multiplyVector(new c(0,0,-1)),m=u.sub(l).normalize(),g=d.sub(l).normalize(),w=f.sub(l).normalize(),p=i?l.added(w.scaled(a)).add(m.scaled(n)).add(g.scaled(-o)):l.added(w.scaled(a));return A.fromPoints(l,p)}getWorldMatrix(){let t=this.offset,e=this.angleAlpha,i=this.angleBeta,s=(new o([1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1]),o.newTranslation(this.pos.x,this.pos.y,this.pos.z)),r=o.newTranslation(t.x,t.y,t.z),n=o.newXRotation(e),a=o.newZRotation(i).multiply(n);return s.multiply(a).multiply(r)}getProjectionMatrix(t){let e=t.width/t.height;return o.newPerspective(this.fov,e,this.zNear,this.zFar)}}class Q{constructor(t){this.camera=t}}var tt,et,it,st=0;(et=tt||(tt={}))[et.StaticDraw=0]="StaticDraw",et[et.DynamicDraw=1]="DynamicDraw";class rt{constructor(t,e,i){this.gl=t,this.program=rt.createProgramFromScripts(t,e,i)}setAndRender(t,e){this.set(t,tt.DynamicDraw),this.render(e)}static getNextTextureID(){let t=st;return st+=1,t}static resizeCanvas(t){let e=t.canvas;const i=e.clientWidth,s=e.clientHeight,r=t.canvas.width!==i||t.canvas.height!==s;return r&&(t.canvas.width=i,t.canvas.height=s),t.viewport(0,0,t.canvas.width,t.canvas.height),r}convertDrawSpeed(t){return t==tt.DynamicDraw?this.gl.DYNAMIC_DRAW:this.gl.STATIC_DRAW}static initWebglContext(t){let e=t.getContext("webgl");null==e&&console.log("webgl unavailable...");let i=e;return i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.enable(i.CULL_FACE),i.enable(i.DEPTH_TEST),i.clearColor(0,0,0,1),i.clearDepth(1),i}static compileShader(t,e,i){let s=t.createShader(i);if(t.shaderSource(s,e),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw"could not compile shader:"+e+t.getShaderInfoLog(s);return s}static createProgram(t,e,i){let s=t.createProgram();if(t.attachShader(s,e),t.attachShader(s,i),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS))throw"program failed to link:"+t.getProgramInfoLog(s);return s}static createProgramFromScripts(t,e,i){let s=rt.compileShader(t,e,t.VERTEX_SHADER),r=rt.compileShader(t,i,t.FRAGMENT_SHADER);return rt.createProgram(t,s,r)}}class nt extends rt{constructor(t,e=[1,0,0,.5]){super(t,"\n        precision mediump int;\n        precision mediump float;\n\n        attribute vec4 a_position;\n        uniform mat4 u_transform;\n        uniform vec4 u_color;\n\n        void main() {\n            gl_Position = u_transform * a_position;\n        }\n        ","\n        precision mediump int;\n        precision mediump float;\n\n        uniform vec4 u_color;\n\n        void main () {\n            gl_FragColor = u_color;\n        }\n        "),this.u_transform=t.getUniformLocation(this.program,"u_transform"),this.u_color=t.getUniformLocation(this.program,"u_color"),this.a_position=t.getAttribLocation(this.program,"a_position"),this.a_position_buffer=t.createBuffer(),this.index_buffer=t.createBuffer(),t.useProgram(this.program),t.uniform4f(this.u_color,e[0],e[1],e[2],e[3]),this.count=0,this.vertCount=0}set(t,i=tt.StaticDraw,s=o.newIdentity()){let r,n,a=this.gl;t instanceof e?(n=t.verts.slice(),r=t.links.getData()):(n=t.verts,r=t.links),a.useProgram(this.program),this.count=r.length,this.vertCount=n.width;let h=this.convertDrawSpeed(i);a.bindBuffer(a.ARRAY_BUFFER,this.a_position_buffer),a.enableVertexAttribArray(this.a_position),a.vertexAttribPointer(this.a_position,this.vertCount,a.FLOAT,!1,0,0),a.bufferData(a.ARRAY_BUFFER,n.data,h),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.index_buffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,r.buffer,h)}render(t){let e=this.gl,i=t.camera.totalMatrix;e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,this.a_position_buffer),e.enableVertexAttribArray(this.a_position),e.vertexAttribPointer(this.a_position,this.vertCount,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.index_buffer),e.uniformMatrix4fv(this.u_transform,!1,i.data),e.drawElements(e.LINES,this.count,e.UNSIGNED_SHORT,0)}setAndRender(t,e){this.set(t,tt.DynamicDraw),this.render(e)}}class ot extends rt{constructor(t){super(t,"\n        precision mediump int;\n        precision mediump float;\n\n        attribute vec4 a_vertex;\n        attribute vec4 a_vertex_color;\n\n        uniform mat4 u_transform;\n\n        varying vec4 v_color;\n\n        void main() {\n            gl_Position = u_transform * a_vertex;\n            v_color = a_vertex_color;\n        }\n        ","\n        precision mediump int;\n        precision mediump float;\n\n        varying vec4 v_color;\n\n        void main () {\n            gl_FragColor = v_color;\n        }\n        "),this.u_transform=t.getUniformLocation(this.program,"u_transform"),this.a_position=t.getAttribLocation(this.program,"a_vertex"),this.a_color=t.getAttribLocation(this.program,"a_vertex_color"),this.a_position_buffer=t.createBuffer(),this.a_color_buffer=t.createBuffer(),this.index_buffer=t.createBuffer(),t.useProgram(this.program),this.count=0,this.vertCount=0,this.scale=.4}set(t,e=tt.StaticDraw){let i=this.gl;i.useProgram(this.program);let s,r,n=this.convertDrawSpeed(e);this.vertCount=3;let o=t.getNormalType();if(o==L.Face){let e=t.mesh.links.count();this.count=2*e,s=l.new(this.count),r=l.new(this.count);for(let i=0;i<e;i++){let e=t.getFaceVertices(i).average(),n=t.norms.get(i),o=2*i,a=2*i+1;s.set(o,e),s.set(a,e.add(n.scaled(this.scale)));let h=n.add(new c(1,1,1).div(2));r.set(o,h),r.set(a,h)}}else{if(o!=L.Vertex)return void(this.count=0);{let e=t.mesh.verts.count;this.count=2*e,s=l.new(this.count),r=l.new(this.count);for(let i=0;i<e;i++){let e=t.mesh.verts.get(i),n=t.norms.get(i),o=2*i,a=2*i+1;s.set(o,e),s.set(a,e.add(n.scaled(this.scale)));let h=n.add(new c(1,1,1)).div(2);r.set(o,h),r.set(a,h)}}}i.bindBuffer(i.ARRAY_BUFFER,this.a_position_buffer),i.enableVertexAttribArray(this.a_position),i.vertexAttribPointer(this.a_position,this.vertCount,i.FLOAT,!1,0,0),i.bufferData(i.ARRAY_BUFFER,s.slice().data,n),i.bindBuffer(i.ARRAY_BUFFER,this.a_color_buffer),i.enableVertexAttribArray(this.a_color),i.vertexAttribPointer(this.a_color,this.vertCount,i.FLOAT,!1,0,0),i.bufferData(i.ARRAY_BUFFER,r.slice().data,n),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.index_buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,E(this.count),n)}render(t){let e=this.gl,i=t.camera.totalMatrix;t.camera,e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,this.a_position_buffer),e.enableVertexAttribArray(this.a_position),e.vertexAttribPointer(this.a_position,this.vertCount,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.a_color_buffer),e.enableVertexAttribArray(this.a_color),e.vertexAttribPointer(this.a_color,this.vertCount,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.index_buffer),e.uniformMatrix4fv(this.u_transform,!1,i.data),e.drawElements(e.LINES,this.count,e.UNSIGNED_SHORT,0)}}class at extends rt{constructor(t,e=[1,0,0,.25]){super(t,"\n        precision mediump int;\n        precision mediump float;\n\n        attribute vec4 a_position;\n        uniform mat4 u_transform;\n        uniform vec4 u_color;\n\n        void main() {\n            gl_Position = u_transform * a_position;\n        }\n        ","\n        precision mediump int;\n        precision mediump float;\n\n        uniform vec4 u_color;\n\n        void main () {\n            gl_FragColor = u_color;\n        }\n        "),this.u_transform=t.getUniformLocation(this.program,"u_transform"),this.u_color=t.getUniformLocation(this.program,"u_color"),t.useProgram(this.program),t.uniform4f(this.u_color,e[0],e[1],e[2],e[3]),this.count=0,this.size=0,this.a_position=t.getAttribLocation(this.program,"a_position"),this.a_position_buffer=t.createBuffer(),this.index_buffer=t.createBuffer()}set(t,e=tt.StaticDraw){let i=this.gl;i.useProgram(this.program),this.count=t.links.data.length,i.bindBuffer(i.ARRAY_BUFFER,this.a_position_buffer),this.size=3,i.FLOAT,i.vertexAttribPointer(this.a_position,this.size,i.FLOAT,!1,0,0),i.bufferData(i.ARRAY_BUFFER,t.verts.slice().data,this.convertDrawSpeed(e)),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.index_buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.links.data,this.convertDrawSpeed(e))}render(t){let e=this.gl,i=t.camera.totalMatrix;e.useProgram(this.program),e.enableVertexAttribArray(this.a_position),e.bindBuffer(e.ARRAY_BUFFER,this.a_position_buffer),e.vertexAttribPointer(this.a_position,this.size,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.index_buffer),e.uniformMatrix4fv(this.u_transform,!1,i.data),e.drawElements(e.TRIANGLES,this.count,e.UNSIGNED_SHORT,0)}setAndRender(t,e){this.set(t,tt.DynamicDraw),this.render(e)}}class ht extends class{setAndRender(t,e){this.set(t,tt.DynamicDraw),this.render(e)}}{constructor(t,e=[1,0,0,.25],i=[1,0,0,1],s=!0){super(),this.faceRend=new at(t,e),this.lineRend=new nt(t,i),this.personal=o.newIdentity(),s&&(this.normRend=new ot(t))}static new(t,e=[1,0,0,.25],i=[1,0,0,1],s=!0){return new ht(t,e,i,s)}set(t,e=tt.StaticDraw){var i;this.personal=t.position,this.faceRend.set(t.mesh),this.lineRend.set(b.fromMesh(t),e),null===(i=this.normRend)||void 0===i||i.set(t,e)}render(t){var e;this.faceRend.render(t),this.lineRend.render(t),null===(e=this.normRend)||void 0===e||e.render(t)}setAndRender(t,e){this.set(t,tt.DynamicDraw),this.render(e)}}class lt extends rt{constructor(t){super(t,"\n\n        attribute vec4 a_vertex_position;\n        attribute vec3 a_vertex_normal;\n        attribute float a_vertex_ambi;\n    \n        uniform mat4 u_normal_matrix;\n        uniform mat4 u_personal_matrix;\n        uniform mat4 u_model_view_matrix;\n        uniform mat4 u_projection_matrix;\n\n        // should be uniforms constances\n        uniform vec3 u_ambient_light;\n        uniform vec3 u_dir_light_color;\n        uniform vec3 u_dir_light_vector;  \n\n        // varying vec2 v_texture_coord;\n        varying vec3 v_lighting;\n    \n        void main(void) {\n\n            gl_Position = u_projection_matrix * u_model_view_matrix * u_personal_matrix * a_vertex_position;\n            // v_texture_coord = a_texture_coord;\n        \n            // Apply lighting effect\n            // highpr is removed\n            vec4 transformedNormal = u_normal_matrix * vec4(a_vertex_normal, 1.0);\n            float directional = max(dot(transformedNormal.xyz, u_dir_light_vector), 0.0);\n            v_lighting = (u_ambient_light + (u_dir_light_color * directional));\n        }\n        ","\n        precision mediump float;\n\n        // Calculates the diffuse factor produced by the light illumination  \n        // if done like this, color could look nicer\n        // float diffuseFactor(vec3 normal, vec3 light_direction) {\n        //     float df = dot(normalize(normal), normalize(light_direction));\n        //     if (gl_FrontFacing) {\n        //         df = -df;\n        //     }\n        //     return max(0.0, df);\n        // }\n\n        varying vec3 v_lighting;\n\n        void main() {\n\n            // Fragment shader output\n            gl_FragColor = vec4(v_lighting, 1.0);\n        }\n        "),t.useProgram(this.program),this.count=0,this.size=0,this.u_normal_matrix=t.getUniformLocation(this.program,"u_normal_matrix"),this.u_model_view_matrix=t.getUniformLocation(this.program,"u_model_view_matrix"),this.u_projection_matrix=t.getUniformLocation(this.program,"u_projection_matrix"),this.u_personal_matrix=t.getUniformLocation(this.program,"u_personal_matrix"),this.u_ambient_light=t.getUniformLocation(this.program,"u_ambient_light"),this.u_dir_light_color=t.getUniformLocation(this.program,"u_dir_light_color"),this.u_dir_light_vector=t.getUniformLocation(this.program,"u_dir_light_vector"),this.a_vertex_position=t.getAttribLocation(this.program,"a_vertex_position"),this.a_vertex_postition_buffer=t.createBuffer(),this.a_vertex_normal=t.getAttribLocation(this.program,"a_vertex_normal"),this.a_vertex_normal_buffer=t.createBuffer(),this.a_vertex_ambi=t.getAttribLocation(this.program,"a_vertex_ambi"),this.a_vertex_ambi_buffer=t.createBuffer(),this.index_buffer=t.createBuffer()}set(t,e=tt.StaticDraw){let i=this.gl;this.setShallow(i,t);let s=t.getNormalType();if(s==L.Face){i.useProgram(this.program),this.count=t.mesh.links.data.length;let s=this.convertDrawSpeed(e),r=l.new(this.count),n=l.new(this.count),o=new Float32Array(this.count);t.mesh.links.count();for(let e=0;e<t.mesh.links.count();e++){let i=t.norms.get(e);t.mesh.links.getRow(e).forEach(((s,a)=>{let h=3*e+a;r.set(h,t.mesh.verts.get(s)),n.set(h,i),o[h]=1}))}i.bindBuffer(i.ARRAY_BUFFER,this.a_vertex_postition_buffer),i.vertexAttribPointer(this.a_vertex_position,3,i.FLOAT,!1,0,0),i.bufferData(i.ARRAY_BUFFER,r.slice().data.buffer,s),i.bindBuffer(i.ARRAY_BUFFER,this.a_vertex_normal_buffer),i.vertexAttribPointer(this.a_vertex_normal,3,i.FLOAT,!1,0,0),i.bufferData(i.ARRAY_BUFFER,n.slice().data.buffer,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.index_buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,E(this.count),this.convertDrawSpeed(e))}else if(s==L.Vertex){i.useProgram(this.program);let s=this.convertDrawSpeed(e);t.ambi,t.mesh.links.count(),this.count=t.mesh.links.data.length,i.bindBuffer(i.ARRAY_BUFFER,this.a_vertex_postition_buffer),i.vertexAttribPointer(this.a_vertex_position,3,i.FLOAT,!1,0,0),i.bufferData(i.ARRAY_BUFFER,t.mesh.verts.slice().data,s),i.bindBuffer(i.ARRAY_BUFFER,this.a_vertex_normal_buffer),i.vertexAttribPointer(this.a_vertex_normal,3,i.FLOAT,!1,0,0),i.bufferData(i.ARRAY_BUFFER,t.norms.slice().data,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.index_buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.mesh.links.data,s)}else console.log("cannot render with this normal data");this.count>r.MAX_U16&&(this.count=r.MAX_U16,console.warn("mesh max reached."))}setShallow(t,e){t.useProgram(this.program),t.uniformMatrix4fv(this.u_personal_matrix,!1,e.position.data);let i=e.color,s=i.map((t=>.25*t));s[2]=Math.min(1,1.05*s[2]);let r=i.map((t=>t));r[0]=Math.min(1,1.05*r[0]),r[1]=Math.min(1,1.05*r[1]),r[2]=Math.min(1,1*r[2]),t.uniform3fv(this.u_ambient_light,s.slice(0,3)),t.uniform3fv(this.u_dir_light_color,r.slice(0,3))}render(t){let e=this.gl,i=t.camera;e.useProgram(this.program),e.uniformMatrix4fv(this.u_normal_matrix,!1,o.newIdentity().data),e.uniformMatrix4fv(this.u_model_view_matrix,!1,i.worldMatrix.data),e.uniformMatrix4fv(this.u_projection_matrix,!1,i.projectMatrix.data),i.getMouseWorldRay(e.canvas.width,e.canvas.height,!1).normal,e.uniform3fv(this.u_dir_light_vector,c.unitX().add(c.unitY()).add(c.unitZ()).normalize().toArray()),e.enableVertexAttribArray(this.a_vertex_position),e.bindBuffer(e.ARRAY_BUFFER,this.a_vertex_postition_buffer),e.vertexAttribPointer(this.a_vertex_position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(this.a_vertex_normal),e.bindBuffer(e.ARRAY_BUFFER,this.a_vertex_normal_buffer),e.vertexAttribPointer(this.a_vertex_normal,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.index_buffer),e.drawElements(e.TRIANGLES,this.count,e.UNSIGNED_SHORT,0)}}class ut extends rt{constructor(t){super(t,"\n        // precision mediump int;\n        // precision mediump float;\n\n        attribute vec4 a_position;\n        attribute vec2 a_texcoord;\n\n        uniform mat4 u_transform;\n\n        varying vec2 v_texcoord;\n\n        void main() {\n            gl_Position = u_transform * a_position;\n            v_texcoord = a_texcoord;\n        }\n        ","\n        precision mediump float;\n\n        varying vec2 v_texcoord;\n\n        uniform sampler2D u_texture;\n\n        void main() {\n            gl_FragColor = texture2D(u_texture, v_texcoord);\n        }\n        "),t.useProgram(this.program),this.count=0,this.size=0,this.u_transform=t.getUniformLocation(this.program,"u_transform"),this.u_texture=t.getUniformLocation(this.program,"u_texture"),this.a_position=t.getAttribLocation(this.program,"a_position"),this.a_position_buffer=t.createBuffer(),this.a_texcoord=t.getAttribLocation(this.program,"a_texcoord"),this.a_texcoord_buffer=t.createBuffer(),this.index_buffer=t.createBuffer(),this.texture_id=rt.getNextTextureID(),this.texture=t.createTexture()}static new(t){return new ut(t)}set(t,e){let i=this.gl;t.texture?(i.useProgram(this.program),this.count=t.mesh.links.data.length,i.bindBuffer(i.ARRAY_BUFFER,this.a_position_buffer),i.vertexAttribPointer(this.a_position,3,i.FLOAT,!1,0,0),i.bufferData(i.ARRAY_BUFFER,t.mesh.verts.slice().data,this.convertDrawSpeed(e)),i.bindBuffer(i.ARRAY_BUFFER,this.a_texcoord_buffer),i.vertexAttribPointer(this.a_texcoord,2,i.FLOAT,!1,0,0),i.bufferData(i.ARRAY_BUFFER,t.uvs.toMatrixSlice().data,this.convertDrawSpeed(e)),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.index_buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(t.mesh.links.data),this.convertDrawSpeed(e)),i.activeTexture(i.TEXTURE0+this.texture_id),i.bindTexture(i.TEXTURE_2D,this.texture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t.texture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.generateMipmap(i.TEXTURE_2D)):console.warn("Mesh does not contain a texture!")}render(t){let e=this.gl,i=t.camera.totalMatrix;e.useProgram(this.program),e.uniformMatrix4fv(this.u_transform,!1,i.data),e.uniform1i(this.u_texture,this.texture_id),e.activeTexture(e.TEXTURE0+this.texture_id),e.bindTexture(e.TEXTURE_2D,this.texture),e.enableVertexAttribArray(this.a_position),e.bindBuffer(e.ARRAY_BUFFER,this.a_position_buffer),e.vertexAttribPointer(this.a_position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(this.a_texcoord),e.bindBuffer(e.ARRAY_BUFFER,this.a_texcoord_buffer),e.vertexAttribPointer(this.a_texcoord,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.index_buffer),e.drawElements(e.TRIANGLES,this.count,e.UNSIGNED_SHORT,0)}setAndRender(t,e){this.set(t,tt.DynamicDraw),this.render(e)}}function ct(t){return new Promise(((e,i)=>{let s=new FileReader;s.readAsText(t),s.onload=()=>{e(s.result)},s.onerror=t=>i(t)}))}function dt(t){return new Promise(((e,i)=>{let s=new FileReader;s.readAsText(t),s.onload=()=>{e(JSON.parse(s.result))},s.onerror=t=>i(t)}))}function ft(t){return new Promise(((e,i)=>{let s=new FileReader;s.readAsDataURL(t),s.onload=()=>gt(s).then((t=>e(t)),(t=>i(t)))}))}function mt(t){return new Promise(((e,i)=>{let s=new FileReader;s.readAsDataURL(t),s.onload=()=>gt(s).then((t=>e(t)),(t=>i(t)))}))}function gt(t){return new Promise((function(e,i){let s=document.createElement("img");s.src=t.result,s.onload=()=>e(function(t){var e;let i=document.createElement("canvas");i.width=t.width,i.height=t.height;let s=i.getContext("2d");s.drawImage(t,0,0);let r=s.getImageData(0,0,t.width,t.height);return null===(e=i.parentNode)||void 0===e||e.removeChild(i),r}(s)),s.onerror=()=>i(new Error(`Script load error for ${s}`))}))}!function(t){t[t.A=0]="A",t[t.B=1]="B",t[t.C=2]="C",t[t.D=3]="D",t[t.E=4]="E",t[t.F=5]="F",t[t.G=6]="G",t[t.H=7]="H",t[t.I=8]="I",t[t.J=9]="J",t[t.K=10]="K",t[t.L=11]="L",t[t.M=12]="M",t[t.N=13]="N",t[t.O=14]="O",t[t.P=15]="P",t[t.Q=16]="Q",t[t.R=17]="R",t[t.S=18]="S",t[t.T=19]="T",t[t.U=20]="U",t[t.V=21]="V",t[t.W=22]="W",t[t.X=23]="X",t[t.Y=24]="Y",t[t.Z=25]="Z",t[t.Up=26]="Up",t[t.Down=27]="Down",t[t.Left=28]="Left",t[t.Right=29]="Right",t[t.Space=30]="Space",t[t.Control=31]="Control",t[t.Alt=32]="Alt",t[t.Shift=33]="Shift",t[t.Enter=34]="Enter",t[t.Esc=35]="Esc",t[t.N1=36]="N1",t[t.N2=37]="N2",t[t.N3=38]="N3",t[t.N4=39]="N4",t[t.N5=40]="N5",t[t.N6=41]="N6",t[t.N7=42]="N7",t[t.N8=43]="N8",t[t.N9=44]="N9",t[t.N0=45]="N0",t[t.Plus=46]="Plus",t[t.Minus=47]="Minus",t[t.Backspace=48]="Backspace"}(it||(it={}));class wt{constructor(t){this.mousePos=f.zero(),this.mouseDelta=f.zero(),this.mouseLeftDown=!1,this.mouseLeftPressed=!1,this.mouseLeftPrev=!1,this.mouseRightDown=!1,this.mouseRightPressed=!1,this.mouseRightPrev=!1,this.mouseMiddleDown=!1,this.mouseMiddlePressed=!1,this.mouseMiddlePrev=!1,this.keysDown={},this.keysPressed=[],this.scrollValue=0,this.canvas=t,this.tick=0,this.oldTime=Date.now(),this.newTime=this.oldTime,this.startTime=Date.now(),this.minimumTick=1e3/144,t.addEventListener("mousedown",this.setMouseDown.bind(this)),t.addEventListener("mouseup",this.setMouseUp.bind(this)),t.addEventListener("contextmenu",(t=>{t.preventDefault(),t.stopPropagation()})),document.addEventListener("mousemove",this.setMousePos.bind(this)),t.addEventListener("wheel",this.setMouseScroll.bind(this)),document.addEventListener("touchmove",this.setTouch.bind(this)),t.addEventListener("touchstart",this.setTouch.bind(this)),t.addEventListener("touchend",this.setTouchUp.bind(this));for(let t=0;t<223;t++)this.keysDown[t]=!1;t.addEventListener("keydown",this.onKeyDown.bind(this)),t.addEventListener("keyup",this.onKeyUp.bind(this)),t.focus()}preUpdate(){this.newTime=Date.now(),this.tick=this.newTime-this.oldTime,this.oldTime=this.newTime,this.mouseLeftPressed=this.mouseLeftPrev!=this.mouseLeftDown&&this.mouseLeftDown,this.mouseRightPressed=this.mouseRightPrev!=this.mouseRightDown&&this.mouseRightDown,this.mouseMiddlePressed=this.mouseMiddlePrev!=this.mouseMiddleDown&&this.mouseMiddleDown,this.mouseLeftPrev=this.mouseLeftDown,this.mouseRightPrev=this.mouseRightDown,this.mouseMiddlePrev=this.mouseMiddleDown}postUpdate(){this.keysPressed=[]}IsKeyDown(t){return this.keysDown[t]}IsKeyPressed(t){return this.keysPressed.includes(t)}onKeyDown(t){1!=this.keysDown[t.key]&&(console.log(t.key),this.keysDown[t.key.toLowerCase()]=!0,this.keysPressed.push(t.key))}onKeyUp(t){this.keysDown[t.key.toLowerCase()]=!1}onKeyPressed(t){}setTouch(t){t.preventDefault(),this.mousePos=new f(t.touches[0].clientX,t.touches[0].clientY),this.mouseLeftDown=!0}setTouchUp(t){t.preventDefault(),this.mouseLeftDown=!1}setMouseScroll(t){let e=.1;t.deltaY<0&&(e=-.1),this.scrollValue=Math.max(0,this.scrollValue+e)}setMousePos(t){this.mousePos=new f(t.clientX,t.clientY)}setMouseUp(t){let e=t.buttons;e<4&&(this.mouseMiddleDown=!1),e<2&&(this.mouseRightDown=!1),e<1&&(this.mouseLeftDown=!1)}setMouseDown(t){t.preventDefault(),t.stopPropagation(),this.canvas.focus();let e=t.buttons;return e>=4&&(e-=4,this.mouseMiddleDown=!0),e>=2&&(e-=2,this.mouseRightDown=!0),e>=1&&(e-=1,this.mouseLeftDown=!0),!1}}class pt{constructor(){this.fps=0,this.updateEveryXTicks=100,this.elapsed=0,this.frames=0}update(t){this.frames+=1,this.elapsed+=t.tick,this.elapsed>this.updateEveryXTicks&&(this.setFps(),this.elapsed=0,this.frames=0)}setFps(){this.fps=Math.round(this.frames/this.elapsed*1e3)}getFps(){return this.fps}}class xt{constructor(t,e,i){this.fullscreen=!0,this.fpsInTitle=!0,this.canvas=t,this.gl=e,this.state=new wt(t),this.fpsCounter=new pt,this.ui=new w(i),this.apps=new Map}addApp(t){this.apps.set(t.name,t),this.activateApp(t)}removeApp(t){this.ui.removeContext(t),this.apps.delete(t)}activateApp(t){this.ui.addContext(t.name),this.ui.addText(t.description),t.ui(this.ui),t.start()}update(){this.state.preUpdate(),this.fpsCounter.update(this.state),this.apps.forEach((t=>{t.update(this.state)})),this.state.postUpdate()}draw(){const t=this.canvas,e=this.gl;this.fpsInTitle&&(document.title="fps: "+this.fpsCounter.getFps()),this.fullscreen&&(window.innerHeight==t.height&&window.innerWidth==t.width||(t.height=window.innerHeight,t.style.height=window.innerHeight.toString(),t.width=window.innerWidth,t.style.width=window.innerWidth.toString(),e.viewport(0,0,window.innerWidth,window.innerHeight))),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.apps.forEach((t=>{t.draw(this.gl)}))}}const vt={process:{n_bellus_points:77,point_ranges:{left_eye_set:[30,31,32,33,34,35,36,37,38],right_eye_set:[40,41,42,43,44,45,46,47,39],left_ear_set:[0,1,2],right_ear_set:[12,11,10]},bounding_box_offset:{remark:"left_right_up_down. means: offset indefinetly",ly:[-10,10,-15,15],ry:[-10,10,-15,15],la:[1200,-10,150,150],ra:[-10,1200,150,150]},filtering:{blur_first:1,gaus_k_size:9,median_kernel_size:7,canny_thresh_lower:50,canny_thresh_upper:150,histeq_clip_limit:3,histeq_cell_size:[8,8]}},process_ransac:{seed:3474647,iterations:1e4,radius:5.55,max_radius_deviation:.2,tolerance:.35,min_score:10,"max_deviation_from_guess(i think is is not used anymore)":6,remark:"this stuff here is raw data",radius_iris:5.5,radius_eye:12.25},process_ears:{},process_brows:{},output:{remark:"use this to determine the keys of the output json",file_name:"results.json",pupil_pt_left:"pupil_pt_left",pupil_pt_right:"pupil_pt_right",pupil_pt_flat_left:"pupil_pt_flat_left",pupil_pt_flat_right:"pupil_pt_flat_right",all_dlib_points:"all_dlib_points",ear_pt_left:"ear_pt_left",ear_pt_right:"ear_pt_right",brow_pts_left:"brow_pts_left",brow_pts_right:"brow_pts_right"},debug:{remark:"use output_test_points to export all points generated in inbetween steps",write_debug_points:!0,silent:!1,plot:!1}};var _t=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function o(t){try{h(s.next(t))}catch(t){n(t)}}function a(t){try{h(s.throw(t))}catch(t){n(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((s=s.apply(t,e||[])).next())}))};class yt{static fetchJson(t){return _t(this,void 0,void 0,(function*(){let e=yield fetch(t);return yield e.json()}))}static fetchText(t){return _t(this,void 0,void 0,(function*(){let e=yield fetch(t);return yield e.text()}))}static fetchBlob(t){return _t(this,void 0,void 0,(function*(){let e=yield fetch(t);return yield e.blob()}))}static findFile(t,e){for(let i=0;i<t.length;i++){let s=t.item(i);if(s.name==e)return s}}static promptDownload(t,e){var i=document.createElement("a");i.setAttribute("href","data:text/plain;charset=utf-8, "+encodeURIComponent(e)),i.setAttribute("download",t),document.body.appendChild(i),i.click(),document.body.removeChild(i)}}class bt{constructor(t,e,i,s,r,n){this.format=t,this.mesh=e,this.facepoints=i,this.faceuvs=s,this.applepoints=r,this.settings=n}}var Et=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function o(t){try{h(s.next(t))}catch(t){n(t)}}function a(t){try{h(s.throw(t))}catch(t){n(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((s=s.apply(t,e||[])).next())}))};const Rt="http://localhost:9000/scans/image/",At="http://localhost:9000/scans/mesh/",Mt="http://localhost:9000/scans/meta/";var Tt,Pt;(Pt=Tt||(Tt={}))[Pt.None=0]="None",Pt[Pt.Bellus=1]="Bellus",Pt[Pt.NextCloudDataset=2]="NextCloudDataset",Pt[Pt.ARKit=3]="ARKit";class Lt{static parse(t){return Et(this,void 0,void 0,(function*(){let e=this.getFormat(t),i=yt.findFile;if(e==Tt.Bellus)return console.log("found a bellus-style dataset! not implemented..."),this.processBellus();if(e==Tt.NextCloudDataset){console.log("found a scan from the nextcloud format! processing...");let e=yield ft(i(t,"head3d.jpg")),s=yield ct(i(t,"head3d.obj")),r=yield ct(i(t,"scaninfo.txt"));return this.processNextcloud(s,e,r)}if(e==Tt.ARKit){console.log("found a scan with ARKit format! not implemented yet...");let e=yield ft(i(t,"head3d.jpg")),s=yield ct(i(t,"head3d.obj")),r=yield dt(i(t,"arFaceData.json")),n=yield dt(i(t,"shapediver-export-request.json"));return this.processArKit(s,e,n,r)}return Promise.reject("couldnt read the files you gave me...")}))}static loadAvailableScans(){return Et(this,void 0,void 0,(function*(){alert("TODO!")}))}static loadArKitFromLocalServer(t){return Et(this,void 0,void 0,(function*(){console.log("requesting data with id = ",t);let e=yield yt.fetchBlob(Rt+t.toString()),i=yield yt.fetchText(At+t.toString()),s=yield yt.fetchJson(Mt+t.toString()),r=yield yt.fetchJson("http://localhost:9000/scans/apple/"+t.toString()),n=yield mt(e);return yield this.processArKit(i,n,s,r)}))}static loadNextcloudFromLocalServer(t){return Et(this,void 0,void 0,(function*(){console.log("requesting data with id = ",t);let e=yield yt.fetchBlob(Rt+t.toString()),i=yield yt.fetchText(At+t.toString()),s=yield yt.fetchText(Mt+t.toString()),r=yield mt(e);return yield this.processNextcloud(i,r,s)}))}static processBellus(){return Et(this,void 0,void 0,(function*(){return Promise.reject("not implemented")}))}static processNextcloud(t,e,i){return Et(this,void 0,void 0,(function*(){return Promise.reject("not implemented")}))}static processArKit(t,e,i,s){return Et(this,void 0,void 0,(function*(){let r=s.arkit,n=i.B3DFaceDataOutput,o=JSON.parse(n),a=o.face_landmarks.Point2f.data,u=o.face_landmarks.Point3f.data,c=(o.ear_landmarks.Point2f.data,o.ear_landmarks.Point3f.data,F(t)),d=H.fromImageData(e);return d=d.flipVer(),c.setTexture(d.toImageData()),d.width,d.height,new bt(Tt.ARKit,c,l.fromData(u),h.fromList(a),l.fromData(r),vt)}))}static getFormat(t){for(let e=0;e<t.length;e++){let i=t.item(e);if("facelandmarks.json"==i.name)return Tt.Bellus;if("scaninfo.txt"==i.name)return Tt.NextCloudDataset;if("shapediver-export-request.json"==i.name)return Tt.ARKit}return Tt.None}static getNextcloudJsonBit(t){return Et(this,void 0,void 0,(function*(){return new Promise((function(e,i){return Et(this,void 0,void 0,(function*(){let s="",r=t.split("\n");for(let t=0;t<r.length;t++){let e=r[t].split(";");2==e.length&&"FACEPOINTJSON"==e[0]&&(s=e[1])}""==s&&(alert("I found a text file, but it does not contain FACEPOINTJSON key, or a valid embedded json"),i());let n=JSON.parse(s);e(n)}))}))}))}}var Dt=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function o(t){try{h(s.next(t))}catch(t){n(t)}}function a(t){try{h(s.throw(t))}catch(t){n(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((s=s.apply(t,e||[])).next())}))};class Ft{constructor(t,e,i,s){this.landmarkData=t,this.mesh=e,this.settings=i,this.json=s}static fromWeb(t,e,i,s){return Dt(this,void 0,void 0,(function*(){return yield new Promise((function(r,n){return Dt(this,void 0,void 0,(function*(){console.log("converting files to usable objects...");let n=yield Lt.getNextcloudJsonBit(i),o=yield mt(e),a=F(t),h=H.fromImageData(o);h=h.flipVer(),a.setTexture(h.toImageData()),console.log("done! nextcloud scan data loaded via web."),r(new Ft(n,a,s,n))}))}))}))}static fromFileList(t,e,i){return Dt(this,void 0,void 0,(function*(){let i,s,r,n;for(let e=0;e<t.length;e++){let o=t.item(e),a=o.name;switch(console.log(`processing ${a}...`),a){case"scaninfo.txt":i=o;break;case"head3d.jpg":s=o;break;case"head3d.obj":r=o;break;case"head3d.obj.mtl":n=o}}return Tt.ARKit,yield new Promise((function(t,o){return Dt(this,void 0,void 0,(function*(){if(null==i||null==s||null==r||null==n)alert("give me at least one .txt, one .obj, one .mtl and one .jpg file please!"),o();else{console.log("converting files to usable objects...");let n=yield ct(i),o=yield Lt.getNextcloudJsonBit(n);console.log("found the following json:"),console.log(o);let a=yield ft(s),h=F(yield ct(r)),l=H.fromImageData(a);l=l.flipVer(),h.setTexture(l.toImageData()),t(new Ft(o,h,e,o))}}))}))}))}getTextureToUVMatrix(){let t=this.mesh.texture,[e,i]=[t.height,t.width],s=o.newScaler(1/i,-1/e,1),r=o.newTranslation(0,1,0);return s.multiply(r)}fromTextureToUVSpace(t){let[e,i]=this.getLandmarksImageSize();console.log("scaling landmarks down by "+i+", "+e);let s=o.newScaler(1/i,-1/e,1),r=o.newTranslation(0,1,0),n=s.multiply(r);return t.clone().transform(n)}getLandmarksImageSize(){let t=this.landmarkData.ImageSize;return[t[0],t[1]]}}class St{static bezierFromPoints(t,e){let i=new Array(e.length);for(let s=0;s<e.length;s++){let r=[t.get(e[s][0]),t.get(e[s][2]),t.get(e[s][3]),t.get(e[s][5])];i[s]=W.fromList(r).getExtention(1)}return i}static nextStep(){}}St.APPLE_LEFT_UPPER_CHEEK=[[649,662,1032,1013,941,579],[669,889,1031,1012,942,489],[670,890,1030,1011,943,888],[806,1046,1029,1010,965,966],[627,1045,1028,1009,999,807]],St.APPLE_RIGHT_UPPER_CHEEK=[[200,227,221,215,947,130],[234,474,236,214,946,39],[235,475,473,466,945,467],[375,458,472,1023,968,57],[178,459,471,940,967,376]];class zt{}zt.FACES_URL="http://localhost:9000/scans/",zt.IMAGE_URL="http://localhost:9000/scans/image/",zt.MESH_URL="http://localhost:9000/scans/mesh/",zt.META_URL="http://localhost:9000/scans/meta/";class Nt{constructor(t){this.elements=new Map;for(let e=0;e<t.length;e++)this.elements.set(t[e],document.getElementById(t[e]))}static new(t){return new Nt(t)}get(t){return this.elements.get(t)}rigParameter(t,e,i=(()=>{})){let s;return s=t instanceof x?t.p:t,e=this.rigRangeInput(s,e,i),t.setSlider(e),e.oninput=()=>{s.set(e.valueAsNumber,!1),i(e.valueAsNumber)},e}rigRangeInput(t,e,i=(()=>{})){return e.type="range",e.min=t.min.toString(),e.max=t.max.toString(),e.valueAsNumber=t.state,e.step=t.step.toString(),e}}class kt{constructor(t,e,i,s,r,n,o,a,h=c.new(),l=f.new()){this.name=t,this.position=e,this.flat=i,this.normal=s,this.color=r,this.xoffset=n,this.yoffset=o,this.plane=a,this.newPosition=h,this.newFlat=l}static new(t,e,i,s,r){return new kt(t,e,i,s,r,0,0,T.WorldXY())}}class Bt{constructor(t,e,i){this.images=t,this.rs=e,this.renderer=i}static new(t){return new Bt([],[],new ut(t))}add(t){this.images.push(t),this.buffer()}buffer(){let t=0;this.images.forEach(((i,s)=>{let r=i.height,n=i.width,o=new V(T.fromPVV(new c(0,0,0),new c(0,0,1),new c(-1,0,0)),g.fromBounds(10,10+n,t,t+r)),a=e.fromRect(o);a.setTexture(i.resize(256,256).toImageData()),this.rs.push(a),t+=r+10}))}draw(t){this.rs.forEach((e=>{this.renderer.setAndRender(e,t)}))}}var Ct,It=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function o(t){try{h(s.next(t))}catch(t){n(t)}}function a(t){try{h(s.throw(t))}catch(t){n(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}h((s=s.apply(t,e||[])).next())}))};class Ut extends class{constructor(t,e=""){this.gl=t,this.name=this.constructor.name,this.description=e}ui(t){}start(){}update(t){}draw(t){}}{constructor(t){super(t),this.camera=new J(t.canvas,1,!0),this.images=Bt.new(t),this.debugger=ht.new(t,[1,0,0,1],[1,1,1,1],!1),this.faceDebugRenderer=ht.new(t,[0,0,0,1],[.5,.5,.5,1],!1),this.cursorRenderer=new at(t,[1,1,1,1]),window.setCurrentPointX=this.setCurrentPointX.bind(this),window.setCurrentPointY=this.setCurrentPointY.bind(this)}ui(t){return It(this,void 0,void 0,(function*(){t.hide(),this.selector=x.new("select",0,["left eye","right eye","left ear","right ear"]),this.xoffset=new p("x",0,-.1,.1,1e-4),this.yoffset=new p("y",0,-.1,.1,1e-4),this.interface=Nt.new(["facepoint-counter","facepoint-title","button-prev","button-reset","button-next","button-submit","vertical-slider","horizontal-slider"]),this.interface.get("button-prev").addEventListener("click",(()=>{this.selector.set(this.selector.get()-1),this.changeFacepoint()})),this.interface.get("button-next").addEventListener("click",(()=>{this.selector.set(this.selector.get()+1),this.changeFacepoint()})),this.interface.get("button-reset").addEventListener("click",(()=>{console.log("reset"),this.resetPoint()})),this.interface.get("button-submit").addEventListener("click",(()=>{this.submitJson()}));let e=this.interface.get("horizontal-slider");console.log(e),this.interface.rigParameter(this.xoffset,this.interface.get("horizontal-slider"),this.offsetPoint.bind(this)),this.interface.rigParameter(this.yoffset,this.interface.get("vertical-slider"),this.offsetPoint.bind(this))}))}start(){if(this.data){let t=this.data,e=this.topo;this.facepoints=[];let i=[...l.fromNative(this.data.json.pupil_pts).toList(),...l.fromNative(this.data.json.ear_pts).toList()],s=["left eye ","right eye","right ear ","left ear"];for(let t=0;t<4;t++){let r=i[t],n=s[t],o=e.flattenClosestPoint(r),a=e.getFaceVertices(e.closestFace(r)).toList(),h=a[1].subbed(a[0]).cross(a[2].subbed(a[0])).normalize();this.facepoints.push(kt.new(n,r,o,h,[1,1,1,1]))}this.bufferEyeEar(),this.meshRenderer=new lt(this.gl),this.faceRenderer=new ut(this.gl),this.faceRenderer.set(t.mesh,tt.StaticDraw),this.changeFacepoint()}else this.loadDebugFace()}update(t){t.IsKeyPressed("o")&&this.setCameraToDefault(),t.IsKeyPressed(" ")&&this.submitJson(),t.IsKeyPressed("J")&&(this.rends=[],this.loadDebugFace()),this.camera.update(t)}draw(){if(!this.rends)return;let t=new Q(this.camera);this.faceRenderer.render(t);for(let e of this.rends)this.cursorRenderer.setAndRender(e.mesh,t);this.data&&this.images.draw(t)}submitJson(){if(console.log("sending json..."),!this.facepoints)return void console.log("no face points yet...");let t=[];for(let e=0;e<this.facepoints.length;e++){const i=this.facepoints[e];let s=new Object({name:i.name,newPosition:i.newPosition,newUV:i.newFlat});t.push(s)}var e,i;e=JSON.stringify(t,null,2),(i=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8, "+encodeURIComponent(e)),i.setAttribute("download","face-points.json"),document.body.appendChild(i),i.click(),document.body.removeChild(i)}bufferEyeEar(t=.1,i=3){let s=this.topo,r=[];this.facepoints.forEach((n=>{let o=n.flat.clone().addn(n.xoffset,n.yoffset),a=s.elevate(o);n.newPosition=a,n.newFlat=o;let h=a,l=e.newSphere(n.position,12*t,8,16),u=c.new(0,0,i),d=c.new(i,0,0),f=c.new(0,i,0),m=e.newCylinder(h.added(u),h.subbed(u),2*t,10),w=e.newCylinder(h.added(d),h.subbed(d),2*t,10),p=e.newCylinder(h.added(f),h.subbed(f),2*t,10),x=g.fromBounds(-50,50,-50,50),v=g.fromBounds(50,-50,50,-50),_=[e.fromRectangle(V.new(T.WorldXY().moveTo(h),x)),e.fromRectangle(V.new(T.WorldXY().moveTo(h),v)),e.fromRectangle(V.new(T.WorldYZ().moveTo(h),x)),e.fromRectangle(V.new(T.WorldYZ().moveTo(h),v)),e.fromRectangle(V.new(T.WorldXZ().moveTo(h),x)),e.fromRectangle(V.new(T.WorldXZ().moveTo(h),v))],y=e.fromJoin([l,m,w,p,..._]).toRenderable();y.color=n.color,y.calculateFaceNormals(),r.push(y)})),this.rends=r}loadDebugFace(t="sybren"){return It(this,void 0,void 0,(function*(){console.log("loading debugface...");let e=yield Vt(`./data/${t}/head3d.obj`),i=yield Vt(`./data/${t}/scaninfo.txt`),s=yield Yt(`./data/${t}/head3d.jpg`),r=yield Ft.fromWeb(e,s,i,{});this.data=r,"jos"==t&&r.mesh.mesh.verts.transform(o.new([1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1])),this.topo=B.copyFromRenderable(r.mesh),this.start()}))}massLoad(t){return It(this,void 0,void 0,(function*(){this.rends=[],this.meshRenderer=new lt(this.gl);for(let t=80;t<100;t++){console.log(t);let e=c.new(400*(t-80),0,0);yield this.loadObj("scan"+t.toString(),e)}}))}loadObj(t,e=c.new(0,0,0)){var i;return It(this,void 0,void 0,(function*(){let s=F(yield Vt(zt.MESH_URL+t));s.mesh.verts.transform(o.newTranslation(e.x,e.y,e.z)),null===(i=this.rends)||void 0===i||i.push(s)}))}loadScan(){return It(this,void 0,void 0,(function*(){if(!this.faceIndex)return void this.loadDebugFace();let t=this.faceIndex.getName();console.log("requesting data with id = ",t);let e=yield Yt(zt.MESH_URL+t.toString()),i=yield Vt(zt.MESH_URL+t.toString()),s=yield Vt(zt.MESH_URL+t.toString()),r=yield Ft.fromWeb(i,e,s,{});this.data=r,this.topo=B.copyFromRenderable(r.mesh),this.start()}))}getSelectedPoint(){if(this.facepoints)return this.facepoints[this.selector.get()];console.log("no facepoints yet")}resetPoint(){if(!this.facepoints)return void console.log("no facepoints yet");let t=this.selector.get(),e=this.facepoints[t];e.xoffset=0,e.yoffset=0,this.xoffset.set(e.xoffset),this.yoffset.set(e.yoffset),this.bufferEyeEar(),this.selectPoint()}changeFacepoint(){let t=this.selector.get(),e=this.selector.getNPermutations();this.interface.get("facepoint-counter").innerHTML=`${t+1}/${e}`,this.interface.get("facepoint-title").innerHTML=this.selector.getName(),this.selectPoint()}selectPoint(){if(!this.facepoints)return void console.log("no facepoints yet");let t=this.selector.get(),e=this.facepoints[t];console.log(e.name,"selected");let i=[.5,.5,.5,1];e.color=[1,1,1,1],this.facepoints.forEach((t=>{e.name!==t.name&&(t.color=i)})),this.bufferEyeEar(),this.xoffset.set(e.xoffset),this.yoffset.set(e.yoffset);let s=e.normal,r=T.WorldXY().pullToPlane(s).toVector2().angle()+1.5*Math.PI;this.setCamera(e.position.clone().scale(-1),t<2?-100:-200,.5*Math.PI,r)}offsetPoint(){let t=this.getSelectedPoint();if(!t)return this.xoffset.set(0),void this.yoffset.set(0);t.xoffset=this.xoffset.get(),t.yoffset=this.yoffset.get(),this.bufferEyeEar()}setCurrentPointX(t){console.log("setting point x to ",t);let e=this.getSelectedPoint();if(!e)return this.xoffset.set(0),void this.yoffset.set(0);e.xoffset=this.xoffset.getDomain().elevate(t),this.bufferEyeEar()}setCurrentPointY(t){console.log("setting point y to ",t);let e=this.getSelectedPoint();if(!e)return this.xoffset.set(0),void this.yoffset.set(0);e.yoffset=this.yoffset.getDomain().elevate(t),this.bufferEyeEar()}setCurrentPointXY(t,e){let i=this.getSelectedPoint();if(!i)return this.xoffset.set(0),void this.yoffset.set(0);i.xoffset=this.xoffset.getDomain().elevate(t),i.yoffset=this.yoffset.getDomain().elevate(e),this.bufferEyeEar()}setCamera(t,e,i,s){this.camera.pos=t,this.camera.z_offset=e,this.camera.angleAlpha=i,this.camera.angleBeta=s}setCameraToDefault(){this.camera.pos=c.new(0,60,40),this.camera.z_offset=-700.36,this.camera.angleAlpha=1.1907963267948962,this.camera.angleBeta=2.4715926535897963}}function Vt(t){return It(this,void 0,void 0,(function*(){let e=yield fetch(t);return yield e.text()}))}function Yt(t){return It(this,void 0,void 0,(function*(){let e=yield fetch(t);return yield e.blob()}))}window.addEventListener("load",(function(){!function(){let t=document.getElementById("canvas"),e=(document.getElementById("camera"),document.getElementById("interface")),i=(document.getElementById("camera-on"),document.getElementById("camera-off"),document.getElementById("predict"),rt.initWebglContext(t));(Ct=new xt(t,i,e)).fullscreen=!1,rt.resizeCanvas(i);let s=new Ut(i);Ct.fullscreen=!1,Ct.addApp(s),requestAnimationFrame((function t(){Ct.update(),Ct.draw(),requestAnimationFrame(t)}))}()}),!1)})();